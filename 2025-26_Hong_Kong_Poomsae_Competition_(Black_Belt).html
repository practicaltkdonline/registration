<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2025-26年度 香港跆拳道品勢比賽(黑帶組) | 2025-26 Hong Kong Poomsae Competition (Black Belt)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Noto Sans TC',Arial,sans-serif;max-width:900px;margin:1rem auto;padding:1rem;background:linear-gradient(135deg,#e6f0fa,#d9e6f5);color:#2d3748;line-height:1.7;min-height:100vh}
    .form-container{background:#fff;padding:2rem;border-radius:1.2rem;box-shadow:0 8px 24px rgba(0,0,0,.12);transition:transform .3s,box-shadow .3s}
    .form-container:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(0,0,0,.18)}
    .form-header{text-align:center;margin-bottom:2.5rem;padding-bottom:1.5rem;border-bottom:2px solid #edf2f7}
    .form-header h1{font-size:1.8rem;font-weight:700;color:#1a202c;margin:0}
    .form-header h2{font-size:1.1rem;font-weight:500;color:#718096;margin-top:.5rem}
    .progress-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;position:relative;height:40px}
    .progress-bar::before{content:'';position:absolute;top:50%;left:20px;right:20px;height:4px;background:#e2e8f0;transform:translateY(-50%);z-index:1;border-radius:2px}
    .progress-line-fill{position:absolute;top:50%;left:20px;height:4px;background:linear-gradient(90deg,#3182ce,#63b3ed);transform:translateY(-50%);z-index:1;transition:width .5s ease-in-out;border-radius:2px;box-shadow:0 0 6px rgba(49,130,206,.4)}
    .progress-step{width:40px;height:40px;border-radius:50%;background:#e2e8f0;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:1rem;color:#4a5568;position:relative;z-index:2;transition:all .3s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .progress-step.active{background:linear-gradient(45deg,#3182ce,#63b3ed);color:#fff;transform:scale(1.1);box-shadow:0 4px 12px rgba(49,130,206,.4)}
    .progress-step.completed{background:linear-gradient(45deg,#3182ce,#63b3ed);color:#fff;box-shadow:0 3px 10px rgba(49,130,206,.3)}
    .step{display:none}
    .step.active{display:block}
    .form-group{margin-bottom:1.5rem;padding:1.2rem;border-radius:1rem;background:#f7fafc;transition:background .3s,transform .2s;box-shadow:0 2px 8px rgba(0,0,0,.05)}
    .form-group:hover{background:#edf2f7;transform:translateY(-2px)}
    .conditional{margin-top:1rem;padding-left:1.5rem;border-left:4px solid #3182ce;display:none;background:#f8fbff;border-radius:0 .8rem .8rem .8rem}
    .conditional.show{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    label{display:block;margin-bottom:.5rem;font-weight:600;font-size:1rem;color:#2d3748}
    input,select,button{width:100%;padding:.8rem;border:1px solid #e2e8f0;border-radius:.6rem;box-sizing:border-box;font-size:1rem;background:#fff;transition:all .3s;height:2.8rem}
    input:focus,select:focus{outline:none;border-color:#3182ce;box-shadow:0 0 6px rgba(49,130,206,.4);background:#f8fbff}
    .date-group{display:flex;align-items:center;gap:.5rem}
    .date-group select{width:8rem}
    .date-group span{font-size:1rem;color:#2d3748}
    .category-group{display:flex;gap:1.5rem;flex-wrap:wrap;padding:.5rem 0}
    .category-group label{display:flex;align-items:center;font-weight:500;cursor:pointer;font-size:1rem}
    .category-group input[type="checkbox"],.category-group input[type="radio"]{width:18px;height:18px;margin-right:.8rem;cursor:pointer}
    .copy-group{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
    .copy-group input[type="text"],.copy-group input[type="tel"]{flex:1;min-width:200px}
    .copy-group label{display:flex;align-items:center;white-space:nowrap;font-weight:500;font-size:1rem;cursor:pointer}
    .copy-group input[type="checkbox"]{width:18px;height:18px;margin-right:.5rem}
    .error{color:#e53e3e;font-size:.85rem;margin-top:.4rem;display:none}
    .navigation{display:flex;justify-content:space-between;margin-top:2rem;gap:1rem}
    .navigation button{padding:.8rem 1.5rem;border:none;border-radius:.6rem;cursor:pointer;font-weight:600;min-height:44px;flex:1;max-width:45%}
    .nav-prev{background:#edf2f7;color:#718096}
    .nav-prev:hover{background:#e2e8f0}
    .nav-next,#submitBtn{background:linear-gradient(90deg,#3182ce,#2b6cb0);color:#fff}
    .nav-next:hover,#submitBtn:hover{background:linear-gradient(90deg,#2b6cb0,#2c5282)}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);justify-content:center;align-items:flex-start;z-index:1000;padding:2rem 1rem;overflow-y:auto}
    .modal-content{background:#fff;padding:2rem;border-radius:1.2rem;max-width:600px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:0 10px 28px rgba(0,0,0,.2)}
    .modal-content h2{margin-top:0;color:#1a202c}
    .confirm-summary{background:#f8fbff;padding:1.5rem;border-radius:1rem;border-left:5px solid #3182ce;margin:1rem 0;line-height:1.8}
    .confirm-summary strong{color:#1a202c}
    .modal-buttons{display:flex;gap:1rem;margin-top:2rem;justify-content:center;position:sticky;bottom:0;background:#fff;padding:1rem 0}
    button.confirm,button.cancel,button.return-button{padding:.8rem 1.5rem;border:none;border-radius:.6rem;cursor:pointer;min-height:44px;min-width:120px;font-size:1rem}
    button.confirm,button.return-button{background:linear-gradient(90deg,#3182ce,#2b6cb0);color:#fff}
    button.confirm:hover,button.return-button:hover{background:linear-gradient(90deg,#2b6cb0,#2c5282);transform:translateY(-2px)}
    button.cancel{background:#edf2f7;color:#718096}
    button.cancel:hover{background:#e2e8f0;transform:translateY(-2px)}
    #thankYouPage{display:none;background:#fff;padding:3rem 2rem;border-radius:1.2rem;box-shadow:0 8px 24px rgba(0,0,0,.12);text-align:center}
    #thankYouPage h2{font-size:1.8rem;color:#1a202c;margin-bottom:1rem}
    #thankYouPage p{font-size:1.1rem;color:#38a169;margin:1rem 0}
    .required-star{color:#e53e3e}
    @media(max-width:600px){
      .date-group select{width:6.5rem}
      .form-group{padding:.9rem}
      .navigation{gap:.6rem}
    }
  </style>
</head>
<body>

<div class="form-container" id="mainForm">
  <div class="form-header">
    <h1>2025-26年度 香港跆拳道品勢比賽(黑帶組)</h1>
    <h1>2025-26 Hong Kong Poomsae Competition (Black Belt)</h1>
    <h2>報名表</h2>
  </div>

  <div class="progress-bar">
    <div class="progress-line-fill" id="progressLineFill"></div>
    <div class="progress-step active" data-step="1">1</div>
    <div class="progress-step" data-step="2">2</div>
    <div class="progress-step" data-step="3">3</div>
    <div class="progress-step" data-step="4">4</div>
  </div>

  <form id="registrationForm">
    <!-- 步驟一：個人資料 -->
    <div class="step active" data-step="1">
      <h3>步驟一：個人資料</h3>

      <div class="form-group">
        <label>中文姓名 <span class="required-star">*</span></label>
        <input type="text" id="chineseName" name="entry.1000000001" placeholder="如沒有請填寫英文姓名 (請以大寫字母填寫)" required
               oninput="if(!/[\u4e00-\u9fa5]/.test(this.value)) this.value=this.value.toUpperCase()">
        <span class="error" id="chineseNameError">請輸入中文姓名或英文姓名</span>
      </div>

      <div class="form-group">
        <label>英文姓名 <span class="required-star">*</span></label>
        <input type="text" id="englishName" name="entry.1000000002" placeholder="請以大寫字母填寫" required oninput="this.value=this.value.toUpperCase()">
        <span class="error" id="englishNameError">請輸入英文姓名</span>
      </div>

      <div class="form-group">
        <label>出生日期 <span class="required-star">*</span></label>
        <div class="date-group">
          <select id="birthYear" name="entry.1000000003_year" required><option value="">年</option></select>
          <span>/</span>
          <select id="birthMonth" name="entry.1000000003_month" required><option value="">月</option></select>
          <span>/</span>
          <select id="birthDay" name="entry.1000000003_day" required><option value="">日</option></select>
        </div>
        <input type="hidden" id="birthDate" name="entry.1000000003">
        <span class="error" id="birthDateError">請選擇出生日期</span>
      </div>

      <div class="form-group">
        <label>性別 <span class="required-star">*</span></label>
        <div class="category-group">
          <label><input type="radio" name="entry.1000000004" value="男 Male" required> 男 Male</label>
          <label><input type="radio" name="entry.1000000004" value="女 Female"> 女 Female</label>
        </div>
        <span class="error" id="genderError">請選擇性別</span>
      </div>

      <div class="form-group">
        <label>國籍 <span class="required-star">*</span></label>
        <input type="text" id="nationality" name="entry.1000000005" required>
        <span class="error" id="nationalityError">請輸入國籍</span>
      </div>

      <div class="form-group">
        <label>聯絡電話 <span class="required-star">*</span></label>
        <input type="tel" id="phone" name="entry.1000000006" pattern="\d{8}" required>
        <span class="error" id="phoneError">請輸入8位數字電話</span>
      </div>

      <div class="form-group">
        <label>緊急聯絡人 <span class="required-star">*</span></label>
        <input type="text" id="emergencyContact" name="entry.1000000007" required>
        <span class="error" id="emergencyContactError">請輸入緊急聯絡人</span>
      </div>

      <div class="form-group">
        <label>緊急聯絡人電話 <span class="required-star">*</span></label>
        <div class="copy-group">
          <input type="tel" id="emergencyPhone" name="entry.1000000008" pattern="\d{8}" required>
          <label><input type="checkbox" id="copyPhone"> 同上</label>
        </div>
        <span class="error" id="emergencyPhoneError">請輸入8位數字電話</span>
      </div>

      <div class="navigation">
        <button type="button" class="nav-prev" disabled>上一步</button>
        <button type="button" class="nav-next" onclick="nextStep()">下一步</button>
      </div>
    </div>

    <!-- 步驟二：級別資料 -->
    <div class="step" data-step="2">
      <h3>步驟二：級別資料</h3>

      <div class="form-group">
        <label>屬會名稱 <span class="required-star">*</span></label>
        <input list="affiliations" id="affiliation" name="entry.1000000009" required placeholder="請輸入或選擇屬會名稱">
        <datalist id="affiliations">
          <!-- 所有屬會略，保持不變 -->
          <option value="香港實用跆拳道協會 HK Practical TKD Association">
          <option value="香港仔跆拳道會 Aberdeen TKD Club">
          <!-- ... 其餘 40+ 個保持原樣 ... -->
        </datalist>
        <span class="error" id="affiliationError">請選擇或輸入屬會名稱</span>
      </div>

      <div class="form-group">
        <label>段證編號 <span class="required-star">*</span></label>
        <div class="copy-group">
          <input type="text" id="danNumber" name="entry.1000000010" required>
          <label><input type="checkbox" id="noDan"> 未有段證</label>
        </div>
        <span class="error" id="danNumberError">請輸入段證編號或勾選未有段證</span>
      </div>

      <div class="form-group">
        <label>段證申請日期（如申請中請填申請當日日期）<span class="required-star">*</span></label>
        <div class="date-group">
          <select id="danYear" name="entry.1000000011_year" required><option value="">年</option></select>
          <span>/</span>
          <select id="danMonth" name="entry.1000000011_month" required><option value="">月</option></select>
          <span>/</span>
          <select id="danDay" name="entry.1000000011_day" required><option value="">日</option></select>
        </div>
        <input type="hidden" id="danDate" name="entry.1000000011">
        <span class="error" id="danDateError">請選擇段證申請日期</span>
      </div>

      <div class="form-group">
        <label>現有級別 <span class="required-star">*</span></label>
        <select id="currentDan" name="entry.1000000012" required>
          <option value="">請選擇級別</option>
          <option value="黑帶一段 1 Dan">黑帶一段 1 Dan</option>
          <option value="黑帶二段 2 Dan">黑帶二段 2 Dan</option>
          <option value="黑帶三段 3 Dan">黑帶三段 3 Dan</option>
          <option value="黑帶四段 4 Dan">黑帶四段 4 Dan</option>
          <option value="黑帶五段 5 Dan">黑帶五段 5 Dan</option>
          <option value="黑帶六段 6 Dan">黑帶六段 6 Dan</option>
          <option value="黑帶七段 7 Dan">黑帶七段 7 Dan</option>
          <option value="黑帶八段 8 Dan">黑帶八段 8 Dan</option>
          <option value="黑帶九段 9 Dan">黑帶九段 9 Dan</option>
          <option value="黑帶一品 1 Poom">黑帶一品 1 Poom</option>
          <option value="黑帶二品 2 Poom">黑帶二品 2 Poom</option>
          <option value="黑帶三品 3 Poom">黑帶三品 3 Poom</option>
        </select>
        <span class="error" id="currentDanError">請選擇現有級別</span>
      </div>

      <div class="navigation">
        <button type="button" class="nav-prev" onclick="prevStep()">上一步</button>
        <button type="button" class="nav-next" onclick="nextStep()">下一步</button>
      </div>
    </div>

    <!-- 步驟三：比賽資料 -->
    <div class="step" data-step="3">
      <h3>步驟三：比賽資料</h3>

      <div class="form-group">
        <label>參加項目（可多選）<span class="required-star">*</span></label>
        <div class="category-group">
          <label><input type="checkbox" id="eventIndividual" value="個人"> 個人</label>
          <label><input type="checkbox" id="eventPair" value="混雙"> 混雙</label>
          <label><input type="checkbox" id="eventTeam" value="團體"> 團體</label>
        </div>
      </div>

      <div class="form-group">
        <label>個人組別 <span class="required-star">*</span></label>
        <select id="individualDivision" name="entry.1000000013" required>
          <option value="">請選擇出生日期與性別後自動帶入</option>
        </select>
        <span class="error" id="individualDivisionError">請確認個人組別已自動帶入</span>
      </div>

      <div class="conditional" id="pairSection">
        <div class="form-group">
          <label>混雙組別（自動帶入）</label>
          <select id="pairDivision" name="entry.1000000014"></select>
        </div>
        <div class="form-group">
          <label>隊員姓名（中文）<span class="required-star">*</span></label>
          <input type="text" id="pairPartner" name="entry.1000000015" placeholder="請輸入隊員中文姓名">
          <span class="error" id="pairPartnerError">請輸入混雙隊員姓名</span>
        </div>
      </div>

      <div class="conditional" id="teamSection">
        <div class="form-group">
          <label>團體組別（自動帶入）</label>
          <select id="teamDivision" name="entry.1000000016"></select>
        </div>
        <div class="form-group">
          <label>隊員1姓名（中文）<span class="required-star">*</span></label>
          <input type="text" id="teamMember1" name="entry.1000000017" placeholder="請輸入隊員中文姓名">
          <span class="error" id="teamMember1Error">請輸入團體隊員1姓名</span>
        </div>
        <div class="form-group">
          <label>隊員2姓名（中文）<span class="required-star">*</span></label>
          <input type="text" id="teamMember2" name="entry.1000000018" placeholder="請輸入隊員中文姓名">
          <span class="error" id="teamMember2Error">請輸入團體隊員2姓名</span>
        </div>
      </div>

      <div class="navigation">
        <button type="button" class="nav-prev" onclick="prevStep()">上一步</button>
        <button type="button" class="nav-next" onclick="nextStep()">下一步</button>
      </div>
    </div>

    <!-- 步驟四：確認及提交 -->
    <div class="step" data-step="4">
      <h3>步驟四：確認及提交</h3>
      <div class="confirm-summary" id="finalSummary"></div>
      <div class="navigation">
        <button type="button" class="nav-prev" onclick="prevStep()">上一步</button>
        <button type="button" id="submitBtn" onclick="submitForm()">提交表單</button>
      </div>
    </div>
  </form>
</div>

<!-- 確認彈窗 -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <h2>請再次確認您的報名資料</h2>
    <div class="confirm-summary" id="confirmContent"></div>
    <div class="modal-buttons">
      <button class="cancel" onclick="document.getElementById('confirmModal').style.display='none'">返回修改</button>
      <button class="confirm" onclick="confirmSubmission()">確認提交</button>
    </div>
  </div>
</div>

<!-- 感謝頁 -->
<div id="thankYouPage" class="modal">
  <div class="modal-content">
    <h2>感謝您的報名！</h2>
    <p>我們已經成功收到您的資料。</p>
    <p>教練將會盡快與您聯繫確認細節。</p>
    <button class="return-button" onclick="location.reload()">重新報名</button>
  </div>
</div>

<script>
  let currentStep = 1;
  const totalSteps = 4;

  const poomsaeDivisions = {
    individual: {
      male: {
        "2014-2015": "10歲 至 11歲 PI1M 個人男品組 Age: 10 to 11 (2014 - 2015年出生者) - 太極六章、高麗",
        "2011-2013": "12歲 至 14歲 PI2M 個人男品組 Age: 12 to 14 (2011 - 2013年出生者) - 太極七章、高麗",
        "2008-2010": "15歲 至 17歲 DI1M 個人男黑組 Age: 15 to 17 (2008 - 2010年出生者) - 高麗、太極七章/八章",
        "1995-2007": "18歲 至 30歲 DI2M 個人男黑組 Age: 18 to 30 (1995 - 2007年出生者) - 太白、高麗/金剛",
        "1985-1994": "31歲 至 40歲 DI3M 個人男黑組 Age: 31 to 40 (1985 - 1994年出生者) - 太白、高麗/金剛",
        "1975-1984": "41歲 至 50歲 DI4M 個人男黑組 Age: 41 to 50 (1975 - 1984年出生者) - 地跆、十進/平原",
        "default": "51歲或以上 DI5M 個人男黑組 Age: 51 or above (1974年或之前出生者) - 地跆、十進/平原"
      },
      female: {
        "2014-2015": "10歲 至 11歲 PI1F 個人女品組 Age: 10 to 11 (2014 - 2015年出生者) - 太極六章、高麗",
        "2011-2013": "12歲 至 14歲 PI2F 個人女品組 Age: 12 to 14 (2011 - 2013年出生者) - 太極七章、高麗",
        "2008-2010": "15歲 至 17歲 DI1F 個人女黑組 Age: 15 to 17 (2008 - 2010年出生者) - 高麗、太極七章/八章",
        "1995-2007": "18歲 至 30歲 DI2F 個人女黑組 Age: 18 to 30 (1995 - 2007年出生者) - 太白、高麗/金剛",
        "1985-1994": "31歲 至 40歲 DI3F 個人女黑組 Age: 31 to 40 (1985 - 1994年出生者) - 太白、高麗/金剛",
        "1975-1984": "41歲 至 50歲 DI4F 個人女黑組 Age: 41 to 50 (1975 - 1984年出生者) - 地跆、十進/平原",
        "default": "51歲或以上 DI5F 個人女黑組 Age: 51 or above (1974年或之前出生者) - 地跆、十進/平原"
      }
    },
    pair: {
      "2011-2013": "12歲 至 14歲 PP2 男女雙人品組 Age: 12 to 14 (2011 - 2013年出生者) - 太極七章、高麗",
      "2008-2010": "15歲 至 17歲 DP1 男女雙人品組 Age: 15 to 17 (2008 - 2010年出生者) - 高麗、太極七章/八章",
      "1995-2007": "18歲 至 30歲 DP2 男女雙人品組 Age: 18 to 30 (1995 - 2007年出生者) - 太白、高麗/金剛",
      "1985-1994": "31歲 至 40歲 DP3 男女雙人品組 Age: 31 to 40 (1985 - 1994年出生者) - 太白、高麗/金剛",
      "1975-1984": "41歲 至 50歲 DP4 男女雙人品組 Age: 41 to 50 (1975 - 1984年出生者) - 地跆、十進/平原",
      "default": "51歲或以上 DP5 男女雙人品組 Age: 51 or above (1974年或之前出生者) - 地跆、十進/平原"
    },
    team: {
      male: {
        "2011-2013": "12歲 至 14歲 PT2M 男子團體品組 Age: 12 to 14 (2011 - 2013年出生者) - 太極七章、高麗",
        "2008-2010": "15歲 至 17歲 DT1M 男子團體黑帶組 Age: 15 to 17 (2008 - 2010年出生者) - 高麗、太極七章/八章",
        "1995-2007": "18歲 至 30歲 DT2M 男子團體黑帶組 Age: 18 to 30 (1995 - 2007年出生者) - 太白、高麗/金剛",
        "1985-1994": "31歲 至 40歲 DT3M 男子團體黑帶組 Age: 31 to 40 (1985 - 1994年出生者) - 太白、高麗/金剛",
        "1975-1984": "41歲 至 50歲 DT4M 男子團體黑帶組 Age: 41 to 50 (1975 - 1984年出生者) - 地跆、十進/平原",
        "default": "51歲或以上 DT5M 男子團體黑帶組 Age: 51 or above (1974年或之前出生者) - 地跆、十進/平原"
      },
      female: {
        "2011-2013": "12歲 至 14歲 PT2F 女子團體品組 Age: 12 to 14 (2011 - 2013年出生者) - 太極七章、高麗",
        "2008-2010": "15歲 至 17歲 DT1F 女子團體黑帶組 Age: 15 to 17 (2008 - 2010年出生者) - 高麗、太極七章/八章",
        "1995-2007": "18歲 至 30歲 DT2F 女子團體黑帶組 Age: 18 to 30 (1995 - 2007年出生者) - 太白、高麗/金剛",
        "1985-1994": "31歲 至 40歲 DT3F 女子團體黑帶組 Age: 31 to 40 (1985 - 1994年出生者) - 太白、高麗/金剛",
        "1975-1984": "41歲 至 50歲 DT4F 女子團體黑帶組 Age: 41 to 50 (1975 - 1984年出生者) - 地跆、十進/平原",
        "default": "51歲或以上 DT5F 女子團體黑帶組 Age: 51 or above (1974年或之前出生者) - 地跆、十進/平原"
      }
    }
  };

  function updateProgress() {
    document.querySelectorAll('.progress-step').forEach((step, i) => {
      const n = i + 1;
      step.classList.toggle('active', n === currentStep);
      step.classList.toggle('completed', n < currentStep);
    });
    const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
    document.getElementById('progressLineFill').style.width = progress + '%';
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
    document.querySelector('.nav-prev').disabled = currentStep === 1;
    if (currentStep === 4) updateFinalSummary();
  }

  function nextStep() { if (validateStep(currentStep)) { currentStep++; updateProgress(); updateAllDivisions(); toggleConditionalSections(); } }
  function prevStep() { currentStep--; updateProgress(); toggleConditionalSections(); }

  function getAgeGroup(year) {
    if (year >= 2014 && year <= 2015) return "2014-2015";
    if (year >= 2011 && year <= 2013) return "2011-2013";
    if (year >= 2008 && year <= 2010) return "2008-2010";
    if (year >= 1995 && year <= 2007) return "1995-2007";
    if (year >= 1985 && year <= 1994) return "1985-1994";
    if (year >= 1975 && year <= 1984) return "1975-1984";
    return "default";
  }

  function updateAllDivisions() {
    const year = parseInt(document.getElementById('birthYear').value);
    const gender = document.querySelector('input[name="entry.1000000004"]:checked')?.value;
    if (!year || !gender) return;
    const isMale = gender.includes('男');
    const ageKey = getAgeGroup(year);

    // 個人
    const individualDiv = isMale ? poomsaeDivisions.individual.male[ageKey] || poomsaeDivisions.individual.male.default
                                 : poomsaeDivisions.individual.female[ageKey] || poomsaeDivisions.individual.female.default;
    document.getElementById('individualDivision').innerHTML = `<option value="${individualDiv}" selected>${individualDiv}</option>`;

    // 混雙（無10-11歲）
    if (ageKey !== "2014-2015") {
      const pairDiv = poomsaeDivisions.pair[ageKey] || poomsaeDivisions.pair.default;
      document.getElementById('pairDivision').innerHTML = `<option value="${pairDiv}" selected>${pairDiv}</option>`;
    }

    // 團體（無10-11歲）
    if (ageKey !== "2014-2015") {
      const teamDiv = isMale ? poomsaeDivisions.team.male[ageKey] || poomsaeDivisions.team.male.default
                             : poomsaeDivisions.team.female[ageKey] || poomsaeDivisions.team.female.default;
      document.getElementById('teamDivision').innerHTML = `<option value="${teamDiv}" selected>${teamDiv}</option>`;
    }

    if (currentStep === 4) updateFinalSummary();
  }

  function toggleConditionalSections() {
    document.getElementById('pairSection').classList.toggle('show', document.getElementById('eventPair').checked);
    document.getElementById('teamSection').classList.toggle('show', document.getElementById('eventTeam').checked);
  }

  function validateStep(step) {
    const isTest = document.getElementById('chineseName').value.toLowerCase().includes('test');
    if (isTest) return true;
    let valid = true;
    document.querySelectorAll('.error').forEach(e => e.style.display = 'none');

    if (step === 1) {
      if (!document.getElementById('chineseName').value.trim()) { document.getElementById('chineseNameError').style.display = 'block'; valid = false; }
      if (!document.getElementById('englishName').value.trim()) { document.getElementById('englishNameError').style.display = 'block'; valid = false; }
      if (!document.getElementById('birthDate').value) { document.getElementById('birthDateError').style.display = 'block'; valid = false; }
      if (!document.querySelector('input[name="entry.1000000004"]:checked')) { document.getElementById('genderError').style.display = 'block'; valid = false; }
      if (!document.getElementById('nationality').value.trim()) { document.getElementById('nationalityError').style.display = 'block'; valid = false; }
      if (!document.getElementById('phone').value.match(/^\d{8}$/)) { document.getElementById('phoneError').style.display = 'block'; valid = false; }
      if (!document.getElementById('emergencyContact').value.trim()) { document.getElementById('emergencyContactError').style.display = 'block'; valid = false; }
      if (!document.getElementById('emergencyPhone').value.match(/^\d{8}$/)) { document.getElementById('emergencyPhoneError').style.display = 'block'; valid = false; }
    }
    if (step === 2) {
      if (!document.getElementById('affiliation').value.trim()) { document.getElementById('affiliationError').style.display = 'block'; valid = false; }
      if (!document.getElementById('danNumber').value.trim() && !document.getElementById('noDan').checked) { document.getElementById('danNumberError').style.display = 'block'; valid = false; }
      if (!document.getElementById('danDate').value) { document.getElementById('danDateError').style.display = 'block'; valid = false; }
      if (!document.getElementById('currentDan').value) { document.getElementById('currentDanError').style.display = 'block'; valid = false; }
    }
    if (step === 3) {
      const hasIndividual = document.getElementById('eventIndividual').checked;
      const hasPair = document.getElementById('eventPair').checked;
      const hasTeam = document.getElementById('eventTeam').checked;

      if (!hasIndividual && !hasPair && !hasTeam) {
        alert('請至少選擇一個參加項目'); valid = false;
      }
      if (hasIndividual && !document.getElementById('individualDivision').value) {
        document.getElementById('individualDivisionError').style.display = 'block'; valid = false;
      }
      if (hasPair && !document.getElementById('pairPartner').value.trim()) {
        document.getElementById('pairPartnerError').style.display = 'block'; valid = false;
      }
      if (hasTeam) {
        if (!document.getElementById('teamMember1').value.trim()) {
          document.getElementById('teamMember1Error').style.display = 'block'; valid = false;
        }
        if (!document.getElementById('teamMember2').value.trim()) {
          document.getElementById('teamMember  Error').style.display = 'block'; valid = false;
        }
      }
    }
    return valid;
  }

  function updateFinalSummary() {
    const events = [];
    if (document.getElementById('eventIndividual').checked) events.push('個人');
    if (document.getElementById('eventPair').checked) events.push('混雙');
    if (document.getElementById('eventTeam').checked) events.push('團體');

    let summary = `
      <p><strong>中文姓名：</strong> ${document.getElementById('chineseName').value}</p>
      <p><strong>英文姓名：</strong> ${document.getElementById('englishName').value}</p>
      <p><strong>出生日期：</strong> ${document.getElementById('birthDate').value}</p>
      <p><strong>性別：</strong> ${document.querySelector('input[name="entry.1000000004"]:checked')?.value}</p>
      <p><strong>聯絡電話：</strong> ${document.getElementById('phone').value}</p>
      <p><strong>屬會名稱：</strong> ${document.getElementById('affiliation').value}</p>
      <p><strong>段證編號：</strong> ${document.getElementById('noDan').checked ? '未有段證' : document.getElementById('danNumber').value}</p>
      <p><strong>段證申請日期：</strong> ${document.getElementById('danDate').value}</p>
      <p><strong>現有級別：</strong> ${document.getElementById('currentDan').value}</p>
      <p><strong>參加項目：</strong> ${events.length ? events.join('、') : '無'}</p>`;

    if (document.getElementById('eventIndividual').checked) {
      summary += `<p><strong>　個人組別：</strong> ${document.getElementById('individualDivision').value}</p>`;
    }
    if (document.getElementById('eventPair').checked) {
      summary += `<p><strong>　混雙組別：</strong> ${document.getElementById('pairDivision').value}</p>
                  <p><strong>　混雙隊員：</strong> ${document.getElementById('pairPartner').value}</p>`;
    }
    if (document.getElementById('eventTeam').checked) {
      summary += `<p><strong>　團體組別：</strong> ${document.getElementById('teamDivision').value}</p>
                  <p><strong>　團體隊員1：</strong> ${document.getElementById('teamMember1').value}</p>
                  <p><strong>　團體隊員2：</strong> ${document.getElementById('teamMember2').value}</p>`;
    }

    document.getElementById('finalSummary').innerHTML = summary;
  }

  function submitForm() {
    if (!validateStep(4)) return;
    document.getElementById('confirmContent').innerHTML = document.getElementById('finalSummary').innerHTML;
    document.getElementById('confirmModal').style.display = 'flex';
  }

  async function confirmSubmission() {
    const formData = new FormData(document.getElementById('registrationForm'));
    if (document.getElementById('birthYear').value) formData.set('entry.1000000003', document.getElementById('birthDate').value);
    if (document.getElementById('danYear').value) formData.set('entry.1000000011', document.getElementById('danDate').value);
    if (document.getElementById('noDan').checked) formData.set('entry.1000000010', '未有段證');
    if (!document.getElementById('eventPair').checked) { formData.delete('entry.1000000014'); formData.delete('entry.1000000015'); }
    if (!document.getElementById('eventTeam').checked) { formData.delete('entry.1000000016'); formData.delete('entry.1000000017'); formData.delete('entry.1000000018'); }

    try {
      await fetch('https://docs.google.com/forms/d/e/你的真實表單ID/formResponse', { method: 'POST', mode: 'no-cors', body: formData });
    } catch(e) {}
    document.getElementById('confirmModal').style.display = 'none';
    document.getElementById('mainForm').style.display = 'none';
    document.getElementById('thankYouPage').style.display = 'flex';
  }

  function populateDate(selectYear, selectMonth, selectDay, hiddenInput, minYear = 1940) {
    const yearSel = document.getElementById(selectYear);
    const monthSel = document.getElementById(selectMonth);
    const daySel = document.getElementById(selectDay);
    const hidden = document.getElementById(hiddenInput);
    const maxYear = selectYear === 'birthYear' ? 2015 : new Date().getFullYear();
    const startYear = selectYear === 'birthYear' ? 2015 : maxYear;

    for (let y = startYear; y >= minYear; y--) {
      let opt = document.createElement('option'); opt.value = y; opt.text = y;
      yearSel.appendChild(opt);
    }
    for (let m = 1; m <= 12; m++) {
      let opt = document.createElement('option'); opt.value = m; opt.text = m;
      monthSel.appendChild(opt);
    }
    function updateDays() {
      const year = parseInt(yearSel.value);
      const month = parseInt(monthSel.value);
      if (!year || !month) { daySel.innerHTML = '<option value="">日</option>'; return; }
      const daysInMonth = new Date(year, month, 0).getDate();
      const prevDay = daySel.value;
      daySel.innerHTML = '<option value="">日</option>';
      for (let d = 1; d <= daysInMonth; d++) {
        let opt = document.createElement('option'); opt.value = d; opt.text = d;
        daySel.appendChild(opt);
      }
      if (prevDay && prevDay <= daysInMonth) daySel.value = prevDay;
      if (year && month && daySel.value) hidden.value = `${year}-${String(month).padStart(2,'0')}-${String(daySel.value).padStart(2,'0')}`;
    }
    yearSel.onchange = monthSel.onchange = daySel.onchange = updateDays;
    updateDays();
  }

  document.addEventListener('DOMContentLoaded', () => {
    updateProgress();
    populateDate('birthYear', 'birthMonth', 'birthDay', 'birthDate', 1940);
    populateDate('danYear', 'danMonth', 'danDay', 'danDate', 1980);

    document.getElementById('noDan').onchange = function() {
      document.getElementById('danNumber').disabled = this.checked;
      if (this.checked) document.getElementById('danNumber').value = '';
    };

    document.getElementById('copyPhone').onchange = function() {
      if (this.checked) document.getElementById('emergencyPhone').value = document.getElementById('phone').value;
    };
    document.getElementById('phone').oninput = function() {
      if (document.getElementById('copyPhone').checked) document.getElementById('emergencyPhone').value = this.value;
    };

    document.getElementById('eventIndividual').onchange =
    document.getElementById('eventPair').onchange =
    document.getElementById('eventTeam').onchange = () => { toggleConditionalSections(); updateAllDivisions(); };

    document.getElementById('birthYear').onchange = 
    document.querySelectorAll('input[name="entry.1000000004"]').forEach(r => r.onchange = updateAllDivisions);
    updateAllDivisions();
  });
</script>
</body>
</html>