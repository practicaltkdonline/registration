<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é°‚é­šæ¶Œè·†æ‹³é“ç­å ±åè¡¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #E0F2FE 0%, #F3F4F6 100%);
            color: #1F2937;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .form-container {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            max-width: 960px;
            width: 100%;
            margin: 40px 0;
        }
        .error { border-color: #ef4444; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        .course-row:hover { background-color: #f3f4f6; transition: background-color 0.2s; }
        .course-row { cursor: pointer; }
        .btn { transition: transform 0.2s, background-color: 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .course-card {
            border: 1px solid #D1D5DB;
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #F3F4F6;
        }
        .course-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
        }
        .course-card.selected {
            border: 2px solid #3B82F6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            background-color: #E0F2FE;
        }
        .month-group h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        @media (max-width: 600px) {
            body {
                padding: 12px;
            }
            .form-container {
                padding: 24px;
                margin: 16px 0;
            }
            h1 { font-size: 1.5rem; }
            .course-card {
                padding: 12px;
            }
            .month-group h3 {
                font-size: 1rem;
            }
        }
        .date-table {
            width: 100%;
            margin-top: 0.5rem;
        }
        .date-table td {
            padding: 8px;
            text-align: center;
        }
        .date-table td:first-child {
            background-color: #E0F2FE;
            font-weight: bold;
            color: #1F2937;
        }
        .date-table td input[type="checkbox"] {
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">ğŸ¥‹é°‚é­šæ¶Œè·†æ‹³é“ç­å ±åè¡¨2026ğŸ¥‹</h1>
        <div class="text-left text-gray-600 mt-4">
            <p class="mt-4"><span class="font-bold">èª²ç¨‹è©³æƒ…</span></p>
            <p class="mt-2">ğŸ“ <span class="font-bold">åœ°é»</span>ï¼šé°‚é­šæ¶Œå¸‚æ”¿å¤§æ¨“6æ¨“èˆè¹ˆå®¤</p>
            <p class="mt-4">ğŸ“… <span class="font-bold">é€¢æ˜ŸæœŸæ—¥ä¸Šèª²</span>ï¼Œåˆ†ç‚ºä»¥ä¸‹å…©å€‹æ™‚æ®µï¼š</p>
            <ul class="list-none mt-2">
                <li class="ml-4"><span class="font-bold">åˆç´šç­</span>1å°æ™‚ (3-7æ­²ï¼Œç™½å¸¶è‡³ç¶ å¸¶)</li>
                <li class="ml-4">â° 1æœˆé–‹å§‹å›å¾©æ­£å¸¸ç‚º12:00pm - 1:00pm </li>
                <li class="ml-4 mt-2"><span class="font-bold">é€²éšç­</span>1.5å°æ™‚ (8æ­²æˆ–ä»¥ä¸Šï¼Œç¶ å¸¶æˆ–ä»¥ä¸Š)</li>
                <li class="ml-4">â° 1æœˆé–‹å§‹å›å¾©æ­£å¸¸ç‚º12:30pm - 2:00pm </li>
            </ul>
            
            <p class="mt-4">ğŸ’°<span class="font-bold">è²»ç”¨</span>ï¼šæ¯ç¯€èª²å ‚ </p>
            <ul class="list-none mt-2">
                <li class="ml-4">åˆç´šç­ 1å°æ™‚ $120</li>
                <li class="ml-4">é€²éšç­ 1.5å°æ™‚ $140</li>
            </ul>

            <p class="mt-4"><span class="font-bold">æ”¶è²»æ–¹å¼</span></p>
            <p>åˆ†ç‚º <span class="font-bold">4æœŸ</span> æ”¶è²»ï¼š</p>
            <ul class="list-none mt-">
                <li class="ml-4">ç¬¬ä¸€æœŸ ğŸ“† 1æœˆ - 3æœˆ</li>
                <li class="ml-4">ç¬¬äºŒæœŸ ğŸ“† 4æœˆ - 6æœˆ</li>
                <li class="ml-4">ç¬¬ä¸‰æœŸ ğŸ“† 7æœˆ - 9æœˆ</li>
                <li class="ml-4">ç¬¬å››æœŸ ğŸ“† 10æœˆ - 12æœˆ</li>
            </ul>
            <p class="mt-4"><span class="font-bold">ä»˜æ¬¾æ–¹å¼</span> ğŸ’µ</p>
            <ol class="list-decimal ml-4 mt-2">
                <li><span class="font-bold">FPS</span></li>
                <ul class="list-none ml-4">
                    <li>æˆ¶å£ç·¨è™Ÿï¼š<span class="font-bold">163115645</span></li>
                    <li>åç¨±ï¼š<span class="font-bold">Practical Club Consultants Company Limited</span></li>
                    <li>ä»˜æ¬¾è¨Šæ¯ï¼šè«‹å¯«ä¸Šå°æœ‹å‹å…¨å</li>
                    <li>å®Œæˆå¾Œè«‹æˆªåœ–ä¸¦ WhatsApp æ•™ç·´ç¢ºèª âœ…</li>
                </ul>
                <li class="mt-2"><span class="font-bold">æ”¯ç¥¨</span></li>
                <ul class="list-none ml-4">
                    <li>æŠ¬é ­ï¼š<span class="font-bold">é¦™æ¸¯å¯¦ç”¨è·†æ‹³é“å”æœƒ</span></li>
                </ul>
                <li class="mt-2"><span class="font-bold">ç¾é‡‘</span></li>
                <ul class="list-none ml-4">
                    <li>æ–¼ç¬¬ä¸€å ‚èª²æˆ–ä¹‹å‰äº¤çµ¦æ•™ç·´</li>
                </ul>
            </ol>
            <p class="mt-4">ğŸ“ å¦‚æœ‰ä»»ä½•æŸ¥è©¢ï¼Œæ­¡è¿è¯ç¹« æ­Sirï¼</p>
            <p>ğŸ“± WhatsApp: <a href="https://wa.me/85261504221?text=" target="_blank" class="text-blue-600 hover:underline">61504221</a></p>
        </div>
        <div id="loadingSpinner" class="w-10 h-10 mx-auto my-4 border-4 border-t-transparent border-blue-600 rounded-full animate-spin hidden"></div>
        <div class="space-y-6 mt-6">
            <div>
                <label for="name" class="block text-gray-700 font-semibold">å­¸å“¡å§“å *</label>
                <input id="name" type="text" class="w-full p-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <p id="name-error" class="error-message hidden">è«‹è¼¸å…¥å­¸å“¡å§“åï¼</p>
            </div>
            <div>
                <label for="phone" class="block text-gray-700 font-semibold">è¯çµ¡é›»è©± *</label>
                <input id="phone" type="tel" class="w-full p-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <p id="phone-error" class="error-message hidden">è«‹è¼¸å…¥æœ‰æ•ˆçš„8ä½é›»è©±è™Ÿç¢¼ï¼</p>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold">æ‰€é¸ç­åˆ¥ *</label>
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <div class="course-card" data-value="junior" onclick="selectClass(this)">
                        <h3 class="text-lg font-semibold">åˆç´šç­</h3>
                        <p class="text-gray-600">3-7æ­² ç™½å¸¶è‡³ç¶ å¸¶</p>
                        <p class="text-gray-600">[1æœˆé–‹å§‹å›å¾©æ­£å¸¸ç‚º12:00pm - 1:00pm]</p>
                    </div>
                    <div class="course-card" data-value="advanced" onclick="selectClass(this)">
                        <h3 class="text-lg font-semibold">é€²éšç­</h3>
                        <p class="text-gray-600">8æ­²æˆ–ä»¥ä¸Š ç¶ å¸¶æˆ–ä»¥ä¸Š</p>
                        <p class="text-gray-600">[1æœˆé–‹å§‹å›å¾©æ­£å¸¸ç‚º12:30pm - 2:00pm]</p>
                    </div>
                </div>
                <p id="class-error" class="error-message hidden">è«‹é¸æ“‡ç­åˆ¥ï¼</p>
                <input type="hidden" id="class" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold">è«‹é¸æ“‡æ—¥æœŸ *</label>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600">è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ</span>
                    <button type="button" id="selectAll" class="btn py-1 px-3 rounded-md text-sm text-white bg-blue-600 hover:bg-blue-700">å…¨é¸</button>
                </div>
                <div id="dateContainer" class="text-gray-700"></div>
                <p id="date-selection-error" class="error-message hidden">è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ—¥æœŸï¼</p>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold">ä¸ŠæœŸæœ‰å¦è«‹å‡ *</label>
                <div class="mt-2 space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="leave" value="yes" class="form-radio text-blue-600" required>
                        <span class="ml-2 text-sm text-gray-700">æœ‰</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="leave" value="no" class="form-radio text-blue-600" checked>
                        <span class="ml-2 text-sm text-gray-700">æ²’æœ‰</span>
                    </label>
                </div>
                <p id="leave-error" class="error-message hidden">è«‹é¸æ“‡æ˜¯å¦è«‹å‡ï¼</p>
            </div>
            <div id="leave-date-section" class="hidden">
                <label class="block text-gray-700 font-semibold">è«‹å‡æ—¥æœŸï¼ˆå¦‚æœ‰ï¼‰ *</label>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600">è«‹é¸æ“‡è«‹å‡æ—¥æœŸ</span>
                    <button type="button" id="selectAllLeaveDates" class="btn py-1 px-3 rounded-md text-sm text-white bg-blue-600 hover:bg-blue-700">å…¨é¸</button>
                </div>
                <div id="leaveDateContainer" class="text-gray-700"></div>
                <p id="leave-date-error" class="error-message hidden">è«‹é¸æ“‡è‡³å°‘ä¸€å€‹è«‹å‡æ—¥æœŸï¼</p>
            </div>
            <div id="deduction-section" class="hidden">
                <label class="block text-gray-700 font-semibold">ä¸ŠæœŸæ‰£æ¸› (å ‚) *</label>
                <p id="deduction" class="text-gray-700 mt-1">0</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700">åŒæ„æ¢æ¬¾</h3>
                <div class="mt-4">
                    <p class="text-gray-600">è«‹é–±è®€ä»¥ä¸‹æ¢æ¬¾ä¸¦åŒæ„ï¼š</p>
                    <ol class="list-decimal text-gray-600 ml-4">
                        <li class="mt-2">èª²ç¨‹åé¡æœ‰é™ï¼Œè‹¥å ±åäººæ•¸éå¤šï¼Œæ•™ç·´å°‡æ ¹æ“šå ±åæˆ–å­¸å“¡æ°´å¹³é€²è¡Œç¯©é¸ã€‚</li>
                        <li class="mt-2">èª²ç¨‹å…§å®¹å¯èƒ½å› å­¸å“¡æ°´å¹³ä½œå‡ºèª¿æ•´ã€‚</li>
                        <li class="mt-2">è‹¥å¤©æ–‡å°æ‡¸æ›å…«è™Ÿæˆ–ä»¥ä¸Šé¢±é¢¨æˆ–é»‘è‰²æš´é›¨è­¦å‘Šï¼Œç•¶å¤©èª²ç¨‹å°‡å–æ¶ˆã€‚ç´…é›¨æˆ–é»ƒé›¨å‰‡èª²ç¨‹ç…§å¸¸é€²è¡Œã€‚æ•™ç·´æœƒé€éWhatsAppé€šçŸ¥é€²ä¸€æ­¥å®‰æ’ã€‚</li>
                        <li class="mt-2">ç‚ºç¢ºä¿å®‰å…¨ï¼ŒåƒåŠ è€…å¿…é ˆéµå®ˆæ•™ç·´æŒ‡ç¤ºã€‚é•åå®ˆå‰‡è€…ï¼Œæ•™ç·´ä¿ç•™æ¬Šåˆ©è¦æ±‚å…¶ç«‹å³é€€å‡ºèª²ç¨‹ï¼Œæ‰€ç¹³è²»ç”¨ä¸äºˆé€€é‚„ã€‚åƒåŠ è€…äº¦éœ€ç¢ºèªè‡ªèº«å¥åº·ç‹€æ³é©åˆåƒèˆ‡ã€‚</li>
                        <li class="mt-2">è‹¥å­¸å“¡éœ€è«‹å‡ï¼Œè«‹æå‰é€šéWhatsAppé€šçŸ¥æ•™ç·´ï¼Œç¶“ç¢ºèªå¾Œå¯æ–¼ä¸‹ä¸€æœŸå­¸è²»ä¸­æ‰£æ¸›ç›¸é—œè²»ç”¨ã€‚</li>
                    </ol>
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" id="terms" name="terms" class="form-checkbox mr-2 text-blue-600" required>
                        <label for="terms" class="text-gray-700">æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾</label>
                    </div>
                    <p id="terms-error" class="error-message hidden">è«‹åŒæ„æ¢æ¬¾ï¼</p>
                </div>
            </div>
            <div class="flex justify-between items-center gap-4">
                <button onclick="clearForm()" class="btn bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400">æ¸…é™¤è¡¨å–®</button>
                <button id="submitButton" type="button" class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>
    <div id="confirm-section" class="form-container mt-4 hidden">
        <h2 class="text-xl font-semibold text-center text-gray-700">è«‹ç¢ºèªæ‚¨çš„å ±åè³‡æ–™</h2>
        <div class="text-gray-600 space-y-2 mt-4">
            <p><strong>å­¸å“¡å§“åï¼š</strong><span id="confirm-name"></span></p>
            <p><strong>è¯çµ¡é›»è©±ï¼š</strong><span id="confirm-phone"></span></p>
            <p><strong>ç­åˆ¥ï¼š</strong><span id="confirm-class"></span></p>
            <p><strong>é¸æ“‡æ—¥æœŸï¼š</strong></p>
            <ul id="confirm-dates" class="list-disc text-gray-600 ml-6"></ul>
            <p><strong>ä¸ŠæœŸæœ‰å¦è«‹å‡ï¼š</strong><span id="confirm-leave"></span></p>
            <p><strong>è«‹å‡æ—¥æœŸï¼ˆå¦‚æœ‰ï¼‰ï¼š</strong></p>
            <ul id="confirm-leave-dates" class="list-disc text-gray-600 ml-6"></ul>
            <p><strong>ä¸ŠæœŸæ‰£æ¸› (å ‚)ï¼š</strong><span id="confirm-deduction"></span></p>
            <p><strong>æ¢æ¬¾åŒæ„ï¼š</strong>å·²é–±è®€ä¸¦åŒæ„æ‰€æœ‰æ¢æ¬¾</p>
        </div>
        <div class="flex justify-between mt-4 gap-4">
            <button onclick="returnToForm()" class="btn bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400">è¿”å›</button>
            <button onclick="submitForm()" class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700">æäº¤</button>
        </div>
    </div>
    <div id="thankyou-section" class="form-container text-center mt-6 hidden">
        <h2 class="text-2xl font-bold text-center mb-4">å ±åæˆåŠŸæäº¤ï¼ ğŸ“</h2>
        <p class="text-4xl mt-2">âœ…</p>
        <p class="text-gray-600 mt-2">æ‚¨å°‡é€éWhatsAppæ”¶åˆ°ç¢ºèªè¨Šæ¯åŠä»˜æ¬¾è©³æƒ…ã€‚</p>
        <p class="text-gray-600">å®Œæˆä»˜æ¬¾å¾Œï¼Œå ±åå°‡æ­£å¼ç¢ºèªï¼</p>
        <div class="mt-4">
            <button onclick="clearForm()" class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700">é‡æ–°å ±å</button>
        </div>
    </div>

    <script>
        // Google Sheet é€£çµ
        const spreadsheetId = '1IGczhrahIZF2W6_RUUU9ib5vQ1vkLVDIQEObWxEStgU';
        const sheetName = 'QB';
        const apiUrlDates = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=SELECT%20G%20WHERE%20G%20IS%20NOT%20NULL%20OFFSET%201&sheet=${encodeURIComponent(sheetName)}`;
        const apiUrlLeaveDates = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=SELECT%20H%20WHERE%20H%20IS%20NOT%20NULL%20OFFSET%201&sheet=${encodeURIComponent(sheetName)}`;

        // Google Form æäº¤ URL
        const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScfWNLOP7CqV__g7LtepE9JlAtg49VOWdiWHsSTHWi7gQfiEw/formResponse';

        // å¾Œå‚™æ—¥æœŸï¼ˆ2025å¹´6æœˆ-9æœˆæ˜ŸæœŸæ—¥ï¼Œæ ¼å¼ç‚º dd/mmï¼‰
        const fallbackDates = [
            { date: '1/6', display: '1æ—¥', month: 6 },
            { date: '8/6', display: '8æ—¥', month: 6 },
            { date: '15/6', display: '15æ—¥', month: 6 },
            { date: '22/6', display: '22æ—¥', month: 6 },
            { date: '29/6', display: '29æ—¥', month: 6 },
            { date: '6/7', display: '6æ—¥', month: 7 },
            { date: '20/7', display: '20æ—¥', month: 7 },
            { date: '14/9', display: '14æ—¥', month: 9 },
            { date: '28/9', display: '28æ—¥', month: 9 }
        ];

        // å¾Œå‚™è«‹å‡æ—¥æœŸï¼ˆå‡è¨­ä¸ŠæœŸç‚º2025å¹´1æœˆ-3æœˆï¼Œæ ¼å¼ç‚º dd/mmï¼‰
        const fallbackLeaveDates = [
            { date: '5/1', display: '5æ—¥', month: 1 },
            { date: '12/1', display: '12æ—¥', month: 1 },
            { date: '19/1', display: '19æ—¥', month: 1 },
            { date: '26/1', display: '26æ—¥', month: 1 },
            { date: '2/2', display: '2æ—¥', month: 2 },
            { date: '9/2', display: '9æ—¥', month: 2 },
            { date: '16/2', display: '16æ—¥', month: 2 },
            { date: '2/3', display: '2æ—¥', month: 3 },
            { date: '9/3', display: '9æ—¥', month: 3 }
        ];

        // è½‰ç¾©å‡½æ•¸
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // å°‡ dd/mm è½‰ç‚º MMæœˆDDæ—¥
        function toGoogleFormDateFormat(dateStr) {
            const match = dateStr.match(/^(\d{1,2})\/(\d{1,2})$/);
            if (match) {
                const day = parseInt(match[1], 10).toString().padStart(2, '0');
                const month = parseInt(match[2], 10).toString().padStart(2, '0');
                return `${month}æœˆ${day}æ—¥`;
            }
            return dateStr;
        }

        // å°‡ MMæœˆDDæ—¥ è½‰ç‚º dd/mm
        function toBackendFormat(dateStr) {
            const match = dateStr.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (match) {
                const month = parseInt(match[1], 10);
                const day = parseInt(match[2], 10);
                return `${day}/${month}`;
            }
            return dateStr;
        }

        // å°‡ dd/mm è½‰ç‚º D/Mï¼ˆå»æ‰å‰å°é›¶ï¼‰
        function toGoogleFormLeaveDateFormat(dateStr) {
            const match = dateStr.match(/^(\d{1,2})\/(\d{1,2})$/);
            if (match) {
                const day = parseInt(match[1], 10);
                const month = parseInt(match[2], 10);
                return `${day}/${month}`;
            }
            return dateStr;
        }

        // åˆ‡æ›è¤‡é¸æ¡†ç‹€æ…‹
        function toggleCheckbox(element, type = 'dates') {
            const checkbox = element.querySelector(`input[name="${type}"]`);
            if (checkbox && !checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
            }
            if (type === 'dates' && document.querySelectorAll('input[name="dates"]:checked').length > 0) {
                document.getElementById('date-selection-error').classList.add('hidden');
            } else if (type === 'leaveDates' && document.querySelectorAll('input[name="leaveDates"]:checked').length > 0) {
                document.getElementById('leave-date-error').classList.add('hidden');
            }
            if (type === 'leaveDates') {
                updateDeduction();
            }
        }

        // æ›´æ–°æ‰£æ¸›å ‚æ•¸
        function updateDeduction() {
            const selectedLeaveDates = document.querySelectorAll('input[name="leaveDates"]:checked').length;
            document.getElementById('deduction').textContent = selectedLeaveDates;
        }

        // æ¸²æŸ“æ—¥æœŸåˆ° dateContainer æˆ– leaveDateContainer
        function renderDates(dates, containerId, inputName) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const datesByMonth = {};
            dates.forEach(({ date, display, month }, index) => {
                if (!datesByMonth[month]) {
                    datesByMonth[month] = [];
                }
                datesByMonth[month].push({ date, display, index });
            });

            const table = document.createElement('table');
            table.className = 'date-table';
            const tbody = document.createElement('tbody');

            Object.keys(datesByMonth).sort((a, b) => a - b).forEach(month => {
                const row = document.createElement('tr');
                const monthCell = document.createElement('td');
                monthCell.textContent = `${month}æœˆ`;
                row.appendChild(monthCell);

                for (let i = 0; i < 5; i++) {
                    const dateCell = document.createElement('td');
                    if (i < datesByMonth[month].length) {
                        const { date, display, index } = datesByMonth[month][i];
                        dateCell.innerHTML = `
                            <span class="flex-1">${escapeHtml(display)}</span>
                            <input type="checkbox" id="${inputName}-${index}" name="${inputName}" value="${escapeHtml(date)}" class="form-checkbox text-blue-600" onclick="event.stopPropagation()">
                        `;
                        dateCell.setAttribute('onclick', `toggleCheckbox(this, '${inputName}')`);
                    }
                    row.appendChild(dateCell);
                }

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            container.appendChild(table);
        }

        // å¾ Google Sheet ç²å–æ—¥æœŸä¸¦æŒ‰æœˆä»½åˆ†çµ„
        async function fetchSheetData() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
            try {
                // ç²å–å ±åæ—¥æœŸï¼ˆG åˆ—ï¼‰
                const dateResponse = await fetch(apiUrlDates);
                if (!dateResponse.ok) {
                    throw new Error(`ç„¡æ³•é€£æ¥åˆ° Google Sheets (å ±åæ—¥æœŸ)ï¼ŒHTTP ç‹€æ…‹ç¢¼ï¼š${dateResponse.status}`);
                }
                const dateText = await dateResponse.text();
                const dateJsonString = dateText.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!dateJsonString || !dateJsonString[1]) {
                    throw new Error('ç„¡æ•ˆçš„ Google Sheets JSONP å›æ‡‰ï¼ˆå ±åæ—¥æœŸï¼‰ï¼Œè«‹æª¢æŸ¥å·¥ä½œè¡¨æ˜¯å¦å…¬é–‹ã€‚');
                }
                const dateData = JSON.parse(dateJsonString[1]);
                const dates = [];
                if (dateData.table && dateData.table.rows && dateData.table.rows.length > 0) {
                    dateData.table.rows.forEach((row, index) => {
                        const display = row.c[0]?.v;
                        if (display) {
                            const match = display.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
                            if (match) {
                                const month = parseInt(match[1], 10);
                                const day = parseInt(match[2], 10);
                                const date = `${day}/${month}`;
                                const newDisplay = `${day}æ—¥`;
                                dates.push({ date, display: newDisplay, month, index });
                            }
                        }
                    });
                }
                if (dates.length > 0) {
                    renderDates(dates, 'dateContainer', 'dates');
                } else {
                    alert('å·¥ä½œè¡¨ä¸­ç„¡æœ‰æ•ˆå ±åæ—¥æœŸè³‡æ–™ï¼Œæ—¥æœŸæ ¼å¼æ‡‰ç‚º MMæœˆDDæ—¥ï¼ˆä¾‹å¦‚ 1æœˆ5æ—¥ï¼‰ã€‚å°‡ä½¿ç”¨å¾Œå‚™æ—¥æœŸã€‚');
                    renderDates(fallbackDates, 'dateContainer', 'dates');
                }

                // ç²å–è«‹å‡æ—¥æœŸï¼ˆH åˆ—ï¼‰
                const leaveDateResponse = await fetch(apiUrlLeaveDates);
                if (!leaveDateResponse.ok) {
                    throw new Error(`ç„¡æ³•é€£æ¥åˆ° Google Sheets (è«‹å‡æ—¥æœŸ)ï¼ŒHTTP ç‹€æ…‹ç¢¼ï¼š${leaveDateResponse.status}`);
                }
                const leaveDateText = await leaveDateResponse.text();
                const leaveDateJsonString = leaveDateText.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!leaveDateJsonString || !leaveDateJsonString[1]) {
                    throw new Error('ç„¡æ•ˆçš„ Google Sheets JSONP å›æ‡‰ï¼ˆè«‹å‡æ—¥æœŸï¼‰ï¼Œè«‹æª¢æŸ¥å·¥ä½œè¡¨æ˜¯å¦å…¬é–‹ã€‚');
                }
                const leaveDateData = JSON.parse(leaveDateJsonString[1]);
                const leaveDates = [];
                if (leaveDateData.table && leaveDateData.table.rows && leaveDateData.table.rows.length > 0) {
                    leaveDateData.table.rows.forEach((row, index) => {
                        const display = row.c[0]?.v;
                        if (display) {
                            const match = display.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
                            if (match) {
                                const month = parseInt(match[1], 10);
                                const day = parseInt(match[2], 10);
                                const date = `${day}/${month}`;
                                const newDisplay = `${day}æ—¥`;
                                leaveDates.push({ date, display: newDisplay, month, index });
                            }
                        }
                    });
                }
                if (leaveDates.length > 0) {
                    renderDates(leaveDates, 'leaveDateContainer', 'leaveDates');
                } else {
                    alert('å·¥ä½œè¡¨ä¸­ç„¡æœ‰æ•ˆè«‹å‡æ—¥æœŸè³‡æ–™ï¼Œæ—¥æœŸæ ¼å¼æ‡‰ç‚º MMæœˆDDæ—¥ï¼ˆä¾‹å¦‚ 1æœˆ5æ—¥ï¼‰ã€‚å°‡ä½¿ç”¨å¾Œå‚™è«‹å‡æ—¥æœŸã€‚');
                    renderDates(fallbackLeaveDates, 'leaveDateContainer', 'leaveDates');
                }
            } catch (error) {
                alert(`è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—ï¼š${error.message}\nè«‹ç¢ºä¿ Google Sheet å·²è¨­ç‚ºå…¬é–‹ï¼ŒG åˆ—å’Œ H åˆ—æœ‰ MMæœˆDDæ—¥ æ ¼å¼çš„æ—¥æœŸï¼ˆä¾‹å¦‚ 1æœˆ5æ—¥ï¼‰ï¼Œä¸¦æª¢æŸ¥ spreadsheetId å’Œ sheetName æ˜¯å¦æ­£ç¢ºã€‚å°‡ä½¿ç”¨å¾Œå‚™æ—¥æœŸã€‚\nå¦‚éœ€å”åŠ©ï¼Œè«‹è¯ç¹« WhatsAppï¼š61504221`);
                console.error('Fetch error:', error);
                renderDates(fallbackDates, 'dateContainer', 'dates');
                renderDates(fallbackLeaveDates, 'leaveDateContainer', 'leaveDates');
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // ç­åˆ¥é¸æ“‡
        function selectClass(card) {
            document.querySelectorAll('.course-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('class').value = card.dataset.value;
            document.getElementById('class-error').classList.add('hidden');
        }

        // å…¨é¸æ—¥æœŸé‚è¼¯
        const selectAllButton = document.getElementById('selectAll');
        selectAllButton.addEventListener('click', () => {
            const dateCheckboxes = document.querySelectorAll('input[name="dates"]');
            const allChecked = Array.from(dateCheckboxes).every(cb => cb.checked);
            dateCheckboxes.forEach(cb => cb.checked = !allChecked);
            selectAllButton.textContent = allChecked ? 'å…¨é¸' : 'å–æ¶ˆå…¨é¸';
            document.getElementById('date-selection-error').classList.add('hidden');
        });

        // å…¨é¸è«‹å‡æ—¥æœŸé‚è¼¯
        const selectAllLeaveDatesButton = document.getElementById('selectAllLeaveDates');
        selectAllLeaveDatesButton.addEventListener('click', () => {
            const leaveDateCheckboxes = document.querySelectorAll('input[name="leaveDates"]');
            const allChecked = Array.from(leaveDateCheckboxes).every(cb => cb.checked);
            leaveDateCheckboxes.forEach(cb => cb.checked = !allChecked);
            selectAllLeaveDatesButton.textContent = allChecked ? 'å…¨é¸' : 'å–æ¶ˆå…¨é¸';
            document.getElementById('leave-date-error').classList.add('hidden');
            updateDeduction();
        });

        // å³æ™‚é©—è­‰æ¬„ä½
        function validateField(element) {
            const id = element.id;
            const errorElement = document.getElementById(`${id}-error`);

            if (id === 'name') {
                if (element.value.trim()) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            } else if (id === 'phone') {
                const phoneRegex = /^\d{8}$/;
                if (phoneRegex.test(element.value.trim())) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            } else if (id === 'terms') {
                if (element.checked) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            }
        }

        // è«‹å‡é‚è¼¯
        const leaveRadios = document.querySelectorAll('input[name="leave"]');
        const leaveDateSection = document.getElementById('leave-date-section');
        const deductionSection = document.getElementById('deduction-section');

        leaveRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const isYes = radio.value === 'yes';
                leaveDateSection.classList.toggle('hidden', !isYes);
                deductionSection.classList.toggle('hidden', !isYes);
                if (!isYes) {
                    document.querySelectorAll('input[name="leaveDates"]').forEach(cb => cb.checked = false);
                    document.getElementById('selectAllLeaveDates').textContent = 'å…¨é¸';
                    document.getElementById('deduction').textContent = '0';
                    document.getElementById('leave-date-error').classList.add('hidden');
                }
                document.getElementById('leave-error').classList.add('hidden');
                updateDeduction();
            });
        });

        // ç¶å®šå³æ™‚è¼¸å…¥äº‹ä»¶
        document.getElementById('name').addEventListener('input', function() { validateField(this); });
        document.getElementById('phone').addEventListener('input', function() { validateField(this); });
        document.getElementById('terms').addEventListener('change', function() { validateField(this); });

        // ç¶å®šè«‹å‡æ—¥æœŸè¤‡é¸æ¡†äº‹ä»¶
        document.addEventListener('change', (event) => {
            if (event.target.name === 'leaveDates') {
                updateDeduction();
                if (document.querySelectorAll('input[name="leaveDates"]:checked').length > 0) {
                    document.getElementById('leave-date-error').classList.add('hidden');
                }
            }
        });

        // è¡¨å–®é©—è­‰èˆ‡ç¢ºèªé 
        document.getElementById('submitButton').addEventListener('click', () => {
            const nameInput = document.getElementById('name');
            const name = nameInput.value.trim();
            const phoneInput = document.getElementById('phone');
            const phone = phoneInput.value.trim();
            const classSelected = document.getElementById('class').value;
            const selectedDates = Array.from(document.querySelectorAll('input[name="dates"]:checked')).map(cb => ({
                value: cb.value,
                display: cb.parentElement.querySelector('span').textContent,
                month: parseInt(cb.value.split('/')[1])
            }));
            const leave = document.querySelector('input[name="leave"]:checked')?.value;
            const selectedLeaveDates = Array.from(document.querySelectorAll('input[name="leaveDates"]:checked')).map(cb => ({
                value: cb.value,
                display: cb.parentElement.querySelector('span').textContent,
                month: parseInt(cb.value.split('/')[1])
            }));
            const deduction = selectedLeaveDates.length;
            const terms = document.getElementById('terms').checked;

            // é‡ç½®éŒ¯èª¤ç‹€æ…‹
            nameInput.classList.remove('error');
            document.getElementById('name-error').classList.add('hidden');
            phoneInput.classList.remove('error');
            document.getElementById('phone-error').classList.add('hidden');
            document.getElementById('class-error').classList.add('hidden');
            document.getElementById('date-selection-error').classList.add('hidden');
            document.getElementById('leave-error').classList.add('hidden');
            document.getElementById('leave-date-error').classList.add('hidden');
            document.getElementById('terms').classList.remove('error');
            document.getElementById('terms-error').classList.add('hidden');

            let firstErrorElement = null;

            // é©—è­‰å§“å
            if (!name) {
                nameInput.classList.add('error');
                document.getElementById('name-error').classList.remove('hidden');
                firstErrorElement = nameInput;
            }

            // é©—è­‰é›»è©±
            const phoneRegex = /^\d{8}$/;
            if (!phoneRegex.test(phone)) {
                phoneInput.classList.add('error');
                document.getElementById('phone-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = phoneInput;
            }

            // é©—è­‰ç­åˆ¥
            if (!classSelected) {
                document.getElementById('class-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('class-error');
            }

            // é©—è­‰æ—¥æœŸ
            if (selectedDates.length === 0) {
                document.getElementById('date-selection-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('date-selection-error');
            }

            // é©—è­‰è«‹å‡
            if (!leave) {
                document.getElementById('leave-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('leave-error');
            }

            // é©—è­‰è«‹å‡æ—¥æœŸ
            if (leave === 'yes' && selectedLeaveDates.length === 0) {
                document.getElementById('leave-date-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('leave-date-section');
            }

            // é©—è­‰æ¢æ¬¾
            if (!terms) {
                document.getElementById('terms').classList.add('error');
                document.getElementById('terms-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('terms');
            }

            // å¦‚æœæœ‰éŒ¯èª¤ï¼Œæ»¾å‹•åˆ°ç¬¬ä¸€å€‹éŒ¯èª¤æ¬„ä½ä¸¦èšç„¦
            if (firstErrorElement) {
                firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (firstErrorElement.tagName === 'INPUT' || firstErrorElement.tagName === 'TEXTAREA') {
                    firstErrorElement.focus();
                }
                return;
            }

            // æŒ‰æœˆä»½åˆ†çµ„ä¸¦æ ¼å¼åŒ–å ±åæ—¥æœŸ
            const datesByMonth = {};
            selectedDates.forEach(date => {
                if (!datesByMonth[date.month]) {
                    datesByMonth[date.month] = [];
                }
                datesByMonth[date.month].push(date.display.replace('æ—¥', ''));
            });

            // æ›´æ–°ç¢ºèªé å ±åæ—¥æœŸ
            const confirmDatesElement = document.getElementById('confirm-dates');
            confirmDatesElement.innerHTML = Object.keys(datesByMonth)
                .sort((a, b) => a - b)
                .map(month => `<li>${month}æœˆ${datesByMonth[month].join('æ—¥, ') + 'æ—¥'}</li>`)
                .join('');

            // æŒ‰æœˆä»½åˆ†çµ„ä¸¦æ ¼å¼åŒ–è«‹å‡æ—¥æœŸ
            const leaveDatesByMonth = {};
            selectedLeaveDates.forEach(date => {
                if (!leaveDatesByMonth[date.month]) {
                    leaveDatesByMonth[date.month] = [];
                }
                leaveDatesByMonth[date.month].push(date.display.replace('æ—¥', ''));
            });

            // æ›´æ–°ç¢ºèªé è«‹å‡æ—¥æœŸ
            const confirmLeaveDatesElement = document.getElementById('confirm-leave-dates');
            confirmLeaveDatesElement.innerHTML = Object.keys(leaveDatesByMonth).length > 0
                ? Object.keys(leaveDatesByMonth)
                    .sort((a, b) => a - b)
                    .map(month => `<li>${month}æœˆ${leaveDatesByMonth[month].join('æ—¥, ') + 'æ—¥'}</li>`)
                    .join('')
                : '<li>ç„¡</li>';

            // æ›´æ–°ç¢ºèªé 
            document.getElementById('confirm-name').textContent = name;
            document.getElementById('confirm-phone').textContent = phone;
            document.getElementById('confirm-class').textContent = classSelected === 'junior' ? 'åˆç´š 3-7æ­² ç™½å¸¶è‡³ç¶ å¸¶' : 'é€²éš 8æ­²æˆ–ä»¥ä¸Š ç¶ å¸¶æˆ–ä»¥ä¸Š';
            document.getElementById('confirm-leave').textContent = leave === 'yes' ? 'æœ‰' : 'æ²’æœ‰';
            document.getElementById('confirm-deduction').textContent = leave === 'yes' ? deduction : '0';

            // å„²å­˜æ•¸æ“š
            window.formData = {
                name,
                phone,
                class: classSelected,
                dates: selectedDates,
                leave,
                leaveDates: selectedLeaveDates,
                deduction
            };

            // é¡¯ç¤ºç¢ºèªé 
            document.querySelector('.form-container').classList.add('hidden');
            document.getElementById('confirm-section').classList.remove('hidden');
        });

        function returnToForm() {
            document.getElementById('confirm-section').classList.add('hidden');
            document.querySelector('.form-container').classList.remove('hidden');
        }

        function submitForm() {
            const { name, phone, class: classSelected, dates, leave, leaveDates, deduction } = window.formData;

            // æº–å‚™ Google Form æ•¸æ“š
            const formData = new FormData();
            formData.append('entry.1485466301', name);
            formData.append('entry.1919163075', phone);
            formData.append('entry.781986668', classSelected === 'junior' ? 'åˆç´š 3-7æ­² ç™½å¸¶è‡³ç¶ å¸¶' : 'é€²éš 8æ­²æˆ–ä»¥ä¸Š ç¶ å¸¶æˆ–ä»¥ä¸Š');
            formData.append('entry.1067771173', dates.map(date => toGoogleFormDateFormat(date.value)).join(','));
            formData.append('entry.1731377011', leave === 'yes' ? 'æœ‰' : 'æ²’æœ‰');
            formData.append('entry.762426758', leaveDates.map(date => toGoogleFormLeaveDateFormat(date.value)).join(','));
            formData.append('entry.1394157809', deduction);

            // æäº¤åˆ° Google Form
            fetch(googleFormUrl, {
                method: 'POST',
                body: formData,
                mode: 'no-cors'
            })
            .then(() => {
                document.getElementById('confirm-section').classList.add('hidden');
                document.getElementById('thankyou-section').classList.remove('hidden');
            })
            .catch(error => {
                alert(`æäº¤å¤±æ•—ï¼š${error.message}\nè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ä¸¦è¯ç¹«æ”¯æ´ã€‚`);
                console.error('Submit error:', error);
            });
        }

        function clearForm() {
            document.getElementById('name').value = '';
            document.getElementById('name').classList.remove('error');
            document.getElementById('name-error').classList.add('hidden');
            
            document.getElementById('phone').value = '';
            document.getElementById('phone').classList.remove('error');
            document.getElementById('phone-error').classList.add('hidden');
            
            document.getElementById('class').value = '';
            document.getElementById('class-error').classList.add('hidden');
            document.querySelectorAll('.course-card').forEach(c => c.classList.remove('selected'));
            
            document.querySelectorAll('input[name="dates"]').forEach(cb => cb.checked = false);
            document.getElementById('date-selection-error').classList.add('hidden');
            selectAllButton.textContent = 'å…¨é¸';
            
            leaveRadios.forEach(radio => radio.checked = radio.value === 'no');
            document.getElementById('leave-error').classList.add('hidden');
            document.querySelectorAll('input[name="leaveDates"]').forEach(cb => cb.checked = false);
            document.getElementById('selectAllLeaveDates').textContent = 'å…¨é¸';
            leaveDateSection.classList.add('hidden');
            document.getElementById('deduction').textContent = '0';
            deductionSection.classList.add('hidden');
            document.getElementById('leave-date-error').classList.add('hidden');
            
            document.getElementById('terms').checked = false;
            document.getElementById('terms').classList.remove('error');
            document.getElementById('terms-error').classList.add('hidden');
            
            document.getElementById('thankyou-section').classList.add('hidden');
            document.getElementById('confirm-section').classList.add('hidden');
            document.querySelector('.form-container').classList.remove('hidden');
            
            window.formData = null;
        }

        // åˆæ¬¡è¼‰å…¥æ—¥æœŸè³‡æ–™
        fetchSheetData();
    </script>
</body>
</html>
