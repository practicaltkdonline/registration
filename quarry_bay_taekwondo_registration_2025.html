<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é°‚é­šæ¶Œè·†æ‹³é“ç­å ±åè¡¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, sans-serif;
            max-width: 960px;
            margin: 40px auto;
            padding: 20px;
            background: linear-gradient(135deg, #E0F2FE 0%, #F3F4F6 100%);
            color: #1F2937;
        }
        .form-container {
            background: white;
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .error { border-color: #ef4444; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        .course-row:hover { background-color: #f3f4f6; transition: background-color 0.2s; }
        .course-row { cursor: pointer; }
        .btn { transition: transform 0.2s, background-color: 0.2s; }
        .btn:hover { transform: scale(1.05); }
        .course-card {
            border: 1px solid #D1D5DB;
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #F3F4F6;
        }
        .course-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
        }
        .course-card.selected {
            border: 2px solid #3B82F6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
            background-color: #E0F2FE;
        }
        .month-group h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        @media (max-width: 600px) {
            body {
                margin: 16px auto;
                padding: 12px;
            }
            .form-container {
                padding: 24px;
            }
            h1 { font-size: 1.5rem; }
            .container { padding: 0.5rem; }
            .course-card {
                padding: 12px;
            }
            .month-group h3 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1 class="text-3xl font-bold text-center text-gray-800">é°‚é­šæ¶Œè·†æ‹³é“ç­å ±åè¡¨</h1>
        <div class="text-left text-gray-600 mt-4">
            <p>å®¶é•·ä½ å¥½ï¼</p>
            <p class="mt-2">ğŸ¥‹ <span class="font-bold">é°‚é­šæ¶Œè·†æ‹³é“ç­å ±åè¡¨</span> ğŸ¥‹</p>
            <p class="mt-4"><span class="font-bold">èª²ç¨‹è©³æƒ…</span></p>
            <p>ğŸ“… <span class="font-bold">é€¢æ˜ŸæœŸæ—¥ä¸Šèª²</span>ï¼Œåˆ†ç‚ºä»¥ä¸‹å…©å€‹æ™‚æ®µï¼š</p>
            <ul class="list-none mt-2">
                <li class="ml-4"><span class="font-bold">åˆç´šç­</span> (3-7æ­²ï¼Œç™½å¸¶è‡³ç¶ å¸¶)</li>
                <li class="ml-4">â° 12:00pm - 1:00pm</li>
                <li class="ml-4">[7è‡³10æœˆæ”¹ç‚º11:00am - 12:00pm]</li>
                <li class="ml-4 mt-2"><span class="font-bold">é€²éšç­</span> (8æ­²æˆ–ä»¥ä¸Šï¼Œç¶ å¸¶æˆ–ä»¥ä¸Š)</li>
                <li class="ml-4">â° 12:30pm - 2:00pm</li>
                <li class="ml-4">[7è‡³10æœˆæ”¹ç‚º11:30am - 1:00pm]</li>
            </ul>
            <p class="mt-4">ğŸ’° <span class="font-bold">è²»ç”¨</span>ï¼šæ¯ç¯€èª²å ‚ <span class="font-bold">$110</span></p>
            <p><span class="font-bold">æ”¶è²»æ–¹å¼</span></p>
            <p>åˆ†ç‚º <span class="font-bold">4æœŸ</span> æ”¶è²»ï¼š</p>
            <ul class="list-none mt-2">
                <li class="ml-4">ğŸ“† 1æœˆ - 3æœˆ</li>
                <li class="ml-4">ğŸ“† 4æœˆ - 6æœˆ</li>
                <li class="ml-4">ğŸ“† 7æœˆ - 9æœˆ</li>
                <li class="ml-4">ğŸ“† 10æœˆ - 12æœˆ</li>
            </ul>
            <p class="mt-4"><span class="font-bold">ä»˜æ¬¾æ–¹å¼</span> ğŸ’µ</p>
            <ol class="list-decimal ml-4 mt-2">
                <li><span class="font-bold">FPS</span></li>
                <ul class="list-none ml-4">
                    <li>æˆ¶å£ç·¨è™Ÿï¼š<span class="font-bold">163115645</span></li>
                    <li>åç¨±ï¼š<span class="font-bold">Practical Club Consultants Company Limited</span></li>
                    <li>ä»˜æ¬¾è¨Šæ¯ï¼šè«‹å¯«ä¸Šå°æœ‹å‹å…¨å</li>
                    <li>å®Œæˆå¾Œè«‹æˆªåœ–ä¸¦ WhatsApp æ•™ç·´ç¢ºèª âœ…</li>
                </ul>
                <li class="mt-2"><span class="font-bold">æ”¯ç¥¨</span></li>
                <ul class="list-none ml-4">
                    <li>æŠ¬é ­ï¼š<span class="font-bold">é¦™æ¸¯å¯¦ç”¨è·†æ‹³é“å”æœƒ</span></li>
                </ul>
                <li class="mt-2"><span class="font-bold">ç¾é‡‘</span></li>
                <ul class="list-none ml-4">
                    <li>æ–¼ç¬¬ä¸€å ‚èª²æˆ–ä¹‹å‰äº¤çµ¦æ•™ç·´</li>
                </ul>
            </ol>
            <p class="mt-4">ğŸ“ å¦‚æœ‰ä»»ä½•æŸ¥è©¢ï¼Œæ­¡è¿è¯ç¹« æ­Sirï¼</p>
            <p>ğŸ“± WhatsApp: <a href="https://wa.me/85261504221?text=ä½ å¥½ï¼æƒ³æŸ¥è©¢é°‚é­šæ¶Œè·†æ‹³é“ç­ï¼" target="_blank" class="text-blue-600 hover:underline">61504221</a></p>
        </div>
        <div id="loadingSpinner" class="w-10 h-10 mx-auto my-4 border-4 border-t-transparent border-blue-600 rounded-full animate-spin hidden"></div>
        <div class="space-y-6 mt-6">
            <div>
                <label for="name" class="block text-gray-700 font-semibold">å­¸å“¡å§“å *</label>
                <input id="name" type="text" class="w-full p-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <p id="name-error" class="error-message hidden">è«‹è¼¸å…¥å­¸å“¡å§“åï¼</p>
            </div>
            <div>
                <label for="phone" class="block text-gray-700 font-semibold">è¯çµ¡é›»è©± *</label>
                <input id="phone" type="tel" class="w-full p-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <p id="phone-error" class="error-message hidden">è«‹è¼¸å…¥æœ‰æ•ˆçš„8ä½é›»è©±è™Ÿç¢¼ï¼</p>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold">æ‰€é¸ç­åˆ¥ *</label>
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <div class="course-card" data-value="junior" onclick="selectClass(this)">
                        <h3 class="text-lg font-semibold">åˆç´šç­</h3>
                        <p class="text-gray-600">3-7æ­² ç™½å¸¶è‡³ç¶ å¸¶</p>
                        <p class="text-gray-600">12:00pm - 1:00pm</p>
                        <p class="text-gray-600">[7è‡³10æœˆæ”¹ç‚º11:00am - 12:00pm]</p>
                    </div>
                    <div class="course-card" data-value="advanced" onclick="selectClass(this)">
                        <h3 class="text-lg font-semibold">é€²éšç­</h3>
                        <p class="text-gray-600">8æ­²æˆ–ä»¥ä¸Š ç¶ å¸¶æˆ–ä»¥ä¸Š</p>
                        <p class="text-gray-600">12:30pm - 2:00pm</p>
                        <p class="text-gray-600">[7è‡³10æœˆæ”¹ç‚º11:30am - 1:00pm]</p>
                    </div>
                </div>
                <p id="class-error" class="error-message hidden">è«‹é¸æ“‡ç­åˆ¥ï¼</p>
                <input type="hidden" id="class" required>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold">è«‹é¸æ“‡æ—¥æœŸ *</label>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600">è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ</span>
                    <button type="button" id="selectAll" class="btn py-1 px-3 rounded-md text-sm text-white bg-blue-600 hover:bg-blue-700">å…¨é¸</button>
                </div>
                <div id="dateContainer" class="text-gray-700"></div>
                <p id="date-selection-error" class="error-message hidden">è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ—¥æœŸï¼</p>
            </div>
            <div>
                <label class="block text-gray-700 font-semibold">ä¸ŠæœŸæœ‰å¦è«‹å‡ *</label>
                <div class="mt-2 space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="leave" value="yes" class="form-radio text-blue-600" required>
                        <span class="ml-2 text-sm text-gray-700">æœ‰</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="leave" value="no" class="form-radio text-blue-600" checked>
                        <span class="ml-2 text-sm text-gray-700">æ²’æœ‰</span>
                    </label>
                </div>
                <p id="leave-error" class="error-message hidden">è«‹é¸æ“‡æ˜¯å¦è«‹å‡ï¼</p>
            </div>
            <div id="leave-date-section" class="hidden">
                <label for="leaveDate" class="block text-gray-700 font-semibold">è«‹å‡æ—¥æœŸï¼ˆå¦‚æœ‰ï¼‰</label>
                <input id="leaveDate" type="text" placeholder="è«‹è¼¸å…¥æ—¥æœŸï¼ˆå¦‚ 28/2, 30/3, 16/4â€¦â€¦ï¼‰" class="w-full p-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                <p id="leave-date-error" class="error-message hidden">è«‹è¼¸å…¥è«‹å‡æ—¥æœŸï¼</p>
            </div>
            <div id="deduction-section" class="hidden">
                <label for="deduction" class="block text-gray-700 font-semibold">ä¸ŠæœŸæ‰£æ¸› (å ‚) *</label>
                <input id="deduction" type="number" min="0" step="1" value="0" class="w-20 text-center p-2 mt-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <p id="deduction-error" class="error-message hidden">è«‹è¼¸å…¥éè² æ•´æ•¸ï¼</p>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-700">åŒæ„æ¢æ¬¾</h3>
                <div class="mt-4">
                    <p class="text-gray-600">è«‹é–±è®€ä»¥ä¸‹æ¢æ¬¾ä¸¦åŒæ„ï¼š</p>
                    <ol class="list-decimal text-gray-600 ml-4">
                        <li class="mt-2">èª²ç¨‹åé¡æœ‰é™ï¼Œè‹¥å ±åäººæ•¸éå¤šï¼Œæ•™ç·´å°‡æ ¹æ“šå ±åæˆ–å­¸å“¡æ°´å¹³é€²è¡Œç¯©é¸ã€‚</li>
                        <li class="mt-2">èª²ç¨‹å…§å®¹å¯èƒ½å› å­¸å“¡æ°´å¹³ä½œå‡ºèª¿æ•´ã€‚</li>
                        <li class="mt-2">è‹¥å¤©æ–‡å°æ‡¸æ›å…«è™Ÿæˆ–ä»¥ä¸Šé¢±é¢¨æˆ–é»‘è‰²æš´é›¨è­¦å‘Šï¼Œç•¶å¤©èª²ç¨‹å°‡å–æ¶ˆã€‚ç´…é›¨æˆ–é»ƒé›¨å‰‡èª²ç¨‹ç…§å¸¸é€²è¡Œã€‚æ•™ç·´æœƒé€éWhatsAppé€šçŸ¥é€²ä¸€æ­¥å®‰æ’ã€‚</li>
                        <li class="mt-2">ç‚ºç¢ºä¿å®‰å…¨ï¼ŒåƒåŠ è€…å¿…é ˆéµå®ˆæ•™ç·´æŒ‡ç¤ºã€‚é•åå®ˆå‰‡è€…ï¼Œæ•™ç·´ä¿ç•™æ¬Šåˆ©è¦æ±‚å…¶ç«‹å³é€€å‡ºèª²ç¨‹ï¼Œæ‰€ç¹³è²»ç”¨ä¸äºˆé€€é‚„ã€‚åƒåŠ è€…äº¦éœ€ç¢ºèªè‡ªèº«å¥åº·ç‹€æ³é©åˆåƒèˆ‡ã€‚</li>
                        <li class="mt-2">è‹¥å­¸å“¡éœ€è«‹å‡ï¼Œè«‹æå‰é€šéWhatsAppé€šçŸ¥æ•™ç·´ï¼Œç¶“ç¢ºèªå¾Œå¯æ–¼ä¸‹ä¸€æœŸå­¸è²»ä¸­æ‰£æ¸›ç›¸é—œè²»ç”¨ã€‚</li>
                    </ol>
                    <div class="mt-2 flex items-center">
                        <input type="checkbox" id="terms" name="terms" class="form-checkbox mr-2 text-blue-600" required>
                        <label for="terms" class="text-gray-700">æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°æ¢æ¬¾</label>
                    </div>
                    <p id="terms-error" class="error-message hidden">è«‹åŒæ„æ¢æ¬¾ï¼</p>
                </div>
            </div>
            <div class="flex justify-between items-center gap-4">
                <button onclick="clearForm()" class="btn bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400">æ¸…é™¤è¡¨å–®</button>
                <button id="submitButton" type="button" class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>
    <div id="confirm-section" class="form-container mt-4 hidden">
        <h2 class="text-xl font-semibold text-center text-gray-700">è«‹ç¢ºèªæ‚¨çš„å ±åè³‡æ–™</h2>
        <div class="text-gray-600 space-y-2 mt-4">
            <p><strong>å­¸å“¡å§“åï¼š</strong><span id="confirm-name"></span></p>
            <p><strong>è¯çµ¡é›»è©±ï¼š</strong><span id="confirm-phone"></span></p>
            <p><strong>ç­åˆ¥ï¼š</strong><span id="confirm-class"></span></p>
            <p><strong>é¸æ“‡æ—¥æœŸï¼š</strong></p>
            <ul id="confirm-dates" class="list-disc text-gray-600 ml-6"></ul>
            <p><strong>ä¸ŠæœŸæœ‰å¦è«‹å‡ï¼š</strong><span id="confirm-leave"></span></p>
            <p><strong>è«‹å‡æ—¥æœŸï¼ˆå¦‚æœ‰ï¼‰ï¼š</strong><span id="confirm-leave-date"></span></p>
            <p><strong>ä¸ŠæœŸæ‰£æ¸› (å ‚)ï¼š</strong><span id="confirm-deduction"></span></p>
            <p><strong>æ¢æ¬¾åŒæ„ï¼š</strong>å·²é–±è®€ä¸¦åŒæ„æ‰€æœ‰æ¢æ¬¾</p>
        </div>
        <div class="flex justify-between mt-4 gap-4">
            <button onclick="returnToForm()" class="btn bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400">è¿”å›</button>
            <button onclick="submitForm()" class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700">æäº¤</button>
        </div>
    </div>
    <div id="thankyou-section" class="form-container text-center mt-6 hidden">
        <h2 class="text-2xl font-bold text-center mb-4">å ±åæˆåŠŸæäº¤ï¼ ğŸ“</h2>
        <p class="text-4xl mt-2">âœ…</p>
        <p class="text-gray-600 mt-2">æ‚¨å°‡é€éWhatsAppæ”¶åˆ°ç¢ºèªè¨Šæ¯åŠä»˜æ¬¾è©³æƒ…ã€‚</p>
        <p class="text-gray-600">å®Œæˆä»˜æ¬¾å¾Œï¼Œå ±åå°‡æ­£å¼ç¢ºèªï¼</p>
        <div class="mt-4">
            <button onclick="clearForm()" class="btn bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700">é‡æ–°å ±å</button>
        </div>
    </div>

    <script>
        // Google Sheet é€£çµ
        const spreadsheetId = '1IGczhrahIZF2W6_RUUU9ib5vQ1vkLVDIQEObWxEStgU';
        const sheetName = 'QB';
        const apiUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq=SELECT%20G%20WHERE%20G%20IS%20NOT%20NULL%20OFFSET%201&sheet=${encodeURIComponent(sheetName)}`;

        // Google Form æäº¤ URL
        const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLScfWNLOP7CqV__g7LtepE9JlAtg49VOWdiWHsSTHWi7gQfiEw/formResponse';

        // è½‰ç¾©å‡½æ•¸
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // å¾Œå‚™æ—¥æœŸï¼ˆ2025å¹´1-3æœˆæ˜ŸæœŸæ—¥ï¼Œæ ¼å¼ç‚º MMæœˆDDæ—¥ï¼‰
        const fallbackDates = [
            { date: '5/1', display: '1æœˆ5æ—¥', month: 1 },
            { date: '12/1', display: '1æœˆ12æ—¥', month: 1 },
            { date: '19/1', display: '1æœˆ19æ—¥', month: 1 },
            { date: '26/1', display: '1æœˆ26æ—¥', month: 1 },
            { date: '2/2', display: '2æœˆ2æ—¥', month: 2 },
            { date: '9/2', display: '2æœˆ9æ—¥', month: 2 },
            { date: '16/2', display: '2æœˆ16æ—¥', month: 2 },
            { date: '23/2', display: '2æœˆ23æ—¥', month: 2 },
            { date: '2/3', display: '3æœˆ2æ—¥', month: 3 },
            { date: '9/3', display: '3æœˆ9æ—¥', month: 3 },
            { date: '16/3', display: '3æœˆ16æ—¥', month: 3 },
            { date: '23/3', display: '3æœˆ23æ—¥', month: 3 },
            { date: '30/3', display: '3æœˆ30æ—¥', month: 3 }
        ];

        // å°‡ dd/mm è½‰ç‚º MMæœˆDDæ—¥ï¼ˆä¾‹å¦‚ 5/1 -> 01æœˆ05æ—¥ï¼‰
        function toGoogleFormDateFormat(dateStr) {
            const match = dateStr.match(/^(\d{1,2})\/(\d{1,2})$/);
            if (match) {
                const day = parseInt(match[1], 10).toString().padStart(2, '0');
                const month = parseInt(match[2], 10).toString().padStart(2, '0');
                return `${month}æœˆ${day}æ—¥`;
            }
            return dateStr;
        }

        // å°‡ MMæœˆDDæ—¥ è½‰ç‚º dd/mm
        function toBackendFormat(dateStr) {
            const match = dateStr.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
            if (match) {
                const month = parseInt(match[1], 10);
                const day = parseInt(match[2], 10);
                return `${day}/${month}`;
            }
            return dateStr;
        }

        // åˆ‡æ›è¤‡é¸æ¡†ç‹€æ…‹
        function toggleCheckbox(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (checkbox && !checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
            }
            // æ¸…é™¤æ—¥æœŸéŒ¯èª¤ç‹€æ…‹
            if (document.querySelectorAll('input[name="dates"]:checked').length > 0) {
                document.getElementById('date-selection-error').classList.add('hidden');
            }
        }

        // æ¸²æŸ“æ—¥æœŸåˆ° dateContainer
        function renderDates(dates) {
            const dateContainer = document.getElementById('dateContainer');
            dateContainer.innerHTML = '';
            const datesByMonth = {};
            dates.forEach(({ date, display, month }, index) => {
                if (!datesByMonth[month]) {
                    datesByMonth[month] = [];
                }
                datesByMonth[month].push({ date, display, index });
            });

            Object.keys(datesByMonth)
                .sort((a, b) => a - b)
                .forEach(month => {
                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'month-group';
                    monthDiv.innerHTML = `<h3 class="text-lg font-semibold text-gray-700 mt-4">${month}æœˆ</h3>`;
                    const ul = document.createElement('ul');
                    ul.className = 'list-none';
                    datesByMonth[month].forEach(({ date, display, index }) => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center p-2 course-row';
                        li.setAttribute('onclick', 'toggleCheckbox(this)');
                        li.innerHTML = `
                            <span class="flex-1">${escapeHtml(display)}</span>
                            <input type="checkbox" id="date-${index}" name="dates" value="${escapeHtml(date)}" class="form-checkbox text-blue-600" onclick="event.stopPropagation()">
                        `;
                        ul.appendChild(li);
                    });
                    monthDiv.appendChild(ul);
                    dateContainer.appendChild(monthDiv);
                });
        }

        // å¾ Google Sheet ç²å–æ—¥æœŸä¸¦æŒ‰æœˆä»½åˆ†çµ„
        async function fetchSheetData() {
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•é€£æ¥åˆ° Google Sheetsï¼ŒHTTP ç‹€æ…‹ç¢¼ï¼š${response.status}`);
                }
                const text = await response.text();
                const jsonString = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!jsonString || !jsonString[1]) {
                    throw new Error('ç„¡æ•ˆçš„ Google Sheets JSONP å›æ‡‰ï¼Œè«‹æª¢æŸ¥å·¥ä½œè¡¨æ˜¯å¦å…¬é–‹ã€‚');
                }
                const data = JSON.parse(jsonString[1]);
                if (data.table && data.table.rows && data.table.rows.length > 0) {
                    const dates = [];
                    data.table.rows.forEach((row, index) => {
                        const display = row.c[0]?.v;
                        if (display) {
                            const match = display.match(/^(\d{1,2})æœˆ(\d{1,2})æ—¥$/);
                            if (match) {
                                const month = parseInt(match[1], 10);
                                const day = parseInt(match[2], 10);
                                const date = `${day}/${month}`;
                                dates.push({ date, display, month, index });
                            }
                        }
                    });
                    if (dates.length > 0) {
                        renderDates(dates);
                    } else {
                        alert('å·¥ä½œè¡¨ä¸­ç„¡æœ‰æ•ˆæ—¥æœŸè³‡æ–™ï¼Œæ—¥æœŸæ ¼å¼æ‡‰ç‚º MMæœˆDDæ—¥ï¼ˆä¾‹å¦‚ 1æœˆ5æ—¥ï¼‰ã€‚å°‡ä½¿ç”¨å¾Œå‚™æ—¥æœŸã€‚');
                        renderDates(fallbackDates);
                    }
                } else {
                    alert('å·¥ä½œè¡¨ä¸­ç„¡æœ‰æ•ˆæ—¥æœŸè³‡æ–™ï¼Œè«‹ç¢ºèªå•é¡Œä¸¦å°‡ä½¿ç”¨å¾Œå‚™æ—¥æœŸã€‚');
                    renderDates(fallbackDates);
                }
            } catch (error) {
                alert(`è¼‰å…¥æ—¥æœŸè³‡æ–™å¤±æ•—ï¼š${error.message}\nè«‹ç¢ºä¿ Google Sheet å·²è¨­ç‚ºå…¬é–‹ï¼ŒG åˆ—æœ‰ MMæœˆDDæ—¥ æ ¼å¼çš„æ—¥æœŸï¼ˆä¾‹å¦‚ 1æœˆ5æ—¥ï¼‰ï¼Œä¸¦æª¢æŸ¥ spreadsheetId å’Œ sheetName æ˜¯å¦æ­£ç¢ºã€‚å°‡ä½¿ç”¨å¾Œå‚™æ—¥æœŸã€‚\nå¦‚éœ€å”åŠ©ï¼Œè«‹è¯ç¹« WhatsAppï¼š61504221`);
                console.error('Fetch error:', error);
                renderDates(fallbackDates);
            } finally {
                spinner.classList.add('hidden');
            }
        }

        // ç­åˆ¥é¸æ“‡
        function selectClass(card) {
            document.querySelectorAll('.course-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            document.getElementById('class').value = card.dataset.value;
            document.getElementById('class-error').classList.add('hidden');
        }

        // å…¨é¸æ—¥æœŸé‚è¼¯
        const selectAllButton = document.getElementById('selectAll');
        selectAllButton.addEventListener('click', () => {
            const dateCheckboxes = document.querySelectorAll('input[name="dates"]');
            const allChecked = Array.from(dateCheckboxes).every(cb => cb.checked);
            dateCheckboxes.forEach(cb => cb.checked = !allChecked);
            selectAllButton.textContent = allChecked ? 'å…¨é¸' : 'å–æ¶ˆå…¨é¸';
            document.getElementById('date-selection-error').classList.add('hidden');
        });

        // å³æ™‚é©—è­‰æ¬„ä½
        function validateField(element) {
            const id = element.id;
            const errorElement = document.getElementById(`${id}-error`);

            if (id === 'name') {
                if (element.value.trim()) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            } else if (id === 'phone') {
                const phoneRegex = /^\d{8}$/;
                if (phoneRegex.test(element.value.trim())) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            } else if (id === 'leaveDate') {
                if (!element.disabled && element.value.trim()) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            } else if (id === 'deduction') {
                const value = element.value.trim();
                if (!isNaN(value) && Number.isInteger(Number(value)) && Number(value) >= 0) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            } else if (id === 'terms') {
                if (element.checked) {
                    element.classList.remove('error');
                    errorElement.classList.add('hidden');
                }
            }
        }

        // è«‹å‡é‚è¼¯
        const leaveRadios = document.querySelectorAll('input[name="leave"]');
        const leaveDateInput = document.getElementById('leaveDate');
        const leaveDateSection = document.getElementById('leave-date-section');
        const deductionSection = document.getElementById('deduction-section');
        const deductionInput = document.getElementById('deduction');

        leaveRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const isYes = radio.value === 'yes';
                leaveDateSection.classList.toggle('hidden', !isYes);
                deductionSection.classList.toggle('hidden', !isYes);
                leaveDateInput.disabled = !isYes;
                if (!isYes) {
                    leaveDateInput.value = '';
                    deductionInput.value = '0';
                    leaveDateInput.classList.remove('error');
                    document.getElementById('leave-date-error').classList.add('hidden');
                    deductionInput.classList.remove('error');
                    document.getElementById('deduction-error').classList.add('hidden');
                }
                document.getElementById('leave-error').classList.add('hidden');
            });
        });

        // ç¶å®šå³æ™‚è¼¸å…¥äº‹ä»¶
        document.getElementById('name').addEventListener('input', function() { validateField(this); });
        document.getElementById('phone').addEventListener('input', function() { validateField(this); });
        document.getElementById('leaveDate').addEventListener('input', function() { validateField(this); });
        document.getElementById('deduction').addEventListener('input', function() { validateField(this); });
        document.getElementById('terms').addEventListener('change', function() { validateField(this); });

        // è¡¨å–®é©—è­‰èˆ‡ç¢ºèªé 
        document.getElementById('submitButton').addEventListener('click', () => {
            const nameInput = document.getElementById('name');
            const name = nameInput.value.trim();
            const phoneInput = document.getElementById('phone');
            const phone = phoneInput.value.trim();
            const classSelected = document.getElementById('class').value;
            const selectedDates = Array.from(document.querySelectorAll('input[name="dates"]:checked')).map(cb => ({
                value: cb.value,
                display: cb.parentElement.querySelector('span').textContent
            }));
            const leave = document.querySelector('input[name="leave"]:checked')?.value;
            const leaveDate = document.getElementById('leaveDate').value.trim();
            const deductionValue = deductionInput.value.trim();
            const deduction = parseInt(deductionValue, 10);
            const terms = document.getElementById('terms').checked;

            // é‡ç½®éŒ¯èª¤ç‹€æ…‹
            nameInput.classList.remove('error');
            document.getElementById('name-error').classList.add('hidden');
            phoneInput.classList.remove('error');
            document.getElementById('phone-error').classList.add('hidden');
            document.getElementById('class-error').classList.add('hidden');
            document.getElementById('date-selection-error').classList.add('hidden');
            document.getElementById('leave-error').classList.add('hidden');
            leaveDateInput.classList.remove('error');
            document.getElementById('leave-date-error').classList.add('hidden');
            deductionInput.classList.remove('error');
            document.getElementById('deduction-error').classList.add('hidden');
            document.getElementById('terms').classList.remove('error');
            document.getElementById('terms-error').classList.add('hidden');

            let firstErrorElement = null;

            // é©—è­‰å§“å
            if (!name) {
                nameInput.classList.add('error');
                document.getElementById('name-error').classList.remove('hidden');
                firstErrorElement = nameInput;
            }

            // é©—è­‰é›»è©±
            const phoneRegex = /^\d{8}$/;
            if (!phoneRegex.test(phone)) {
                phoneInput.classList.add('error');
                document.getElementById('phone-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = phoneInput;
            }

            // é©—è­‰ç­åˆ¥
            if (!classSelected) {
                document.getElementById('class-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('class-error');
            }

            // é©—è­‰æ—¥æœŸ
            if (selectedDates.length === 0) {
                document.getElementById('date-selection-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('date-selection-error');
            }

            // é©—è­‰è«‹å‡
            if (!leave) {
                document.getElementById('leave-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('leave-error');
            }

            // é©—è­‰è«‹å‡æ—¥æœŸ
            if (leave === 'yes' && !leaveDate) {
                leaveDateInput.classList.add('error');
                document.getElementById('leave-date-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = leaveDateInput;
            }

            // é©—è­‰æ‰£æ¸›
            if (leave === 'yes' && (isNaN(deduction) || deduction < 0 || !Number.isInteger(Number(deductionValue)))) {
                deductionInput.classList.add('error');
                document.getElementById('deduction-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = deductionInput;
            }

            // é©—è­‰æ¢æ¬¾
            if (!terms) {
                document.getElementById('terms').classList.add('error');
                document.getElementById('terms-error').classList.remove('hidden');
                if (!firstErrorElement) firstErrorElement = document.getElementById('terms');
            }

            // å¦‚æœæœ‰éŒ¯èª¤ï¼Œæ»¾å‹•åˆ°ç¬¬ä¸€å€‹éŒ¯èª¤æ¬„ä½ä¸¦èšç„¦
            if (firstErrorElement) {
                firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                if (firstErrorElement.tagName === 'INPUT' || firstErrorElement.tagName === 'TEXTAREA') {
                    firstErrorElement.focus();
                }
                return;
            }

            // æ›´æ–°ç¢ºèªé 
            document.getElementById('confirm-name').textContent = name;
            document.getElementById('confirm-phone').textContent = phone;
            document.getElementById('confirm-class').textContent = classSelected === 'junior' ? 'åˆç´š 3-7æ­² ç™½å¸¶è‡³ç¶ å¸¶' : 'é€²éš 8æ­²æˆ–ä»¥ä¸Š ç¶ å¸¶æˆ–ä»¥ä¸Š';
            document.getElementById('confirm-dates').innerHTML = selectedDates.map(date => `<li>${date.display}</li>`).join('');
            document.getElementById('confirm-leave').textContent = leave === 'yes' ? 'æœ‰' : 'æ²’æœ‰';
            document.getElementById('confirm-leave-date').textContent = leaveDate || 'ç„¡';
            document.getElementById('confirm-deduction').textContent = leave === 'yes' ? deduction : '0';

            // å„²å­˜æ•¸æ“š
            window.formData = {
                name,
                phone,
                class: classSelected,
                dates: selectedDates,
                leave,
                leaveDate,
                deduction: leave === 'yes' ? deduction : 0
            };

            // é¡¯ç¤ºç¢ºèªé 
            document.querySelector('.form-container').classList.add('hidden');
            document.getElementById('confirm-section').classList.remove('hidden');
        });

        function returnToForm() {
            document.getElementById('confirm-section').classList.add('hidden');
            document.querySelector('.form-container').classList.remove('hidden');
        }

        function submitForm() {
            const { name, phone, class: classSelected, dates, leave, leaveDate, deduction } = window.formData;

            // æº–å‚™ Google Form æ•¸æ“š
            const formData = new FormData();
            formData.append('entry.1485466301', name);
            formData.append('entry.1919163075', phone);
            formData.append('entry.781986668', classSelected === 'junior' ? 'åˆç´š 3-7æ­² ç™½å¸¶è‡³ç¶ å¸¶' : 'é€²éš 8æ­²æˆ–ä»¥ä¸Š ç¶ å¸¶æˆ–ä»¥ä¸Š');
            formData.append('entry.1067771173', dates.map(date => toGoogleFormDateFormat(date.value)).join(','));
            formData.append('entry.1731377011', leave === 'yes' ? 'æœ‰' : 'æ²’æœ‰');
            formData.append('entry.762426758', leaveDate || '');
            formData.append('entry.1394157809', deduction);

            // æäº¤åˆ° Google Form
            fetch(googleFormUrl, {
                method: 'POST',
                body: formData,
                mode: 'no-cors'
            })
            .then(() => {
                document.getElementById('confirm-section').classList.add('hidden');
                document.getElementById('thankyou-section').classList.remove('hidden');
            })
            .catch(error => {
                alert(`æäº¤å¤±æ•—ï¼š${error.message}\nè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯ä¸¦è¯ç¹«æ”¯æ´ã€‚`);
                console.error('Submit error:', error);
            });
        }

        function clearForm() {
            document.getElementById('name').value = '';
            document.getElementById('name').classList.remove('error');
            document.getElementById('name-error').classList.add('hidden');
            
            document.getElementById('phone').value = '';
            document.getElementById('phone').classList.remove('error');
            document.getElementById('phone-error').classList.add('hidden');
            
            document.getElementById('class').value = '';
            document.getElementById('class-error').classList.add('hidden');
            document.querySelectorAll('.course-card').forEach(c => c.classList.remove('selected'));
            
            document.querySelectorAll('input[name="dates"]').forEach(cb => cb.checked = false);
            document.getElementById('date-selection-error').classList.add('hidden');
            selectAllButton.textContent = 'å…¨é¸';
            
            leaveRadios.forEach(radio => radio.checked = radio.value === 'no');
            document.getElementById('leave-error').classList.add('hidden');
            leaveDateInput.value = '';
            leaveDateInput.disabled = true;
            leaveDateSection.classList.add('hidden');
            deductionInput.value = '0';
            deductionSection.classList.add('hidden');
            leaveDateInput.classList.remove('error');
            document.getElementById('leave-date-error').classList.add('hidden');
            deductionInput.classList.remove('error');
            document.getElementById('deduction-error').classList.add('hidden');
            
            document.getElementById('terms').checked = false;
            document.getElementById('terms').classList.remove('error');
            document.getElementById('terms-error').classList.add('hidden');
            
            document.getElementById('thankyou-section').classList.add('hidden');
            document.getElementById('confirm-section').classList.add('hidden');
            document.querySelector('.form-container').classList.remove('hidden');
            
            window.formData = null;
        }

        // åˆæ¬¡è¼‰å…¥æ—¥æœŸè³‡æ–™
        fetchSheetData();
    </script>
</body>
</html>
