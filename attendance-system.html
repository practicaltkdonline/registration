<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>點名考勤系統 v3.5</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-800 min-h-screen">
  <div class="max-w-3xl mx-auto p-4">
    <header class="mb-4 text-center">
      <h1 class="text-3xl font-bold">點名考勤系統</h1>
      <p class="text-sm text-gray-500 mt-1">由 Google Sheet 讀取課程資料，送出至 Google Form</p>
    </header>

    <nav class="mb-4 flex gap-2 justify-center">
      <button id="tab-attend" class="tab-btn px-4 py-2 rounded shadow bg-blue-600 text-white text-base">點名</button>
      <button id="tab-view" class="tab-btn px-4 py-2 rounded shadow bg-white text-gray-800 text-base">查看考勤</button>
    </nav>

    <!-- 點名頁 -->
    <section id="panel-attend">
      <h2 class="text-xl font-semibold mb-3">1. 點名</h2>
      <div id="cards" class="grid grid-cols-1 gap-4"></div>
    </section>

    <!-- 查看頁 -->
    <section id="panel-view" class="hidden">
      <h2 class="text-xl font-semibold mb-3">2. 查看考勤</h2>
      <div class="flex flex-col sm:flex-row gap-2 mb-3">
        <select id="view-course" class="p-2 border rounded w-full"></select>
        <select id="view-year" class="p-2 border rounded w-full"></select>
        <select id="view-month" class="p-2 border rounded w-full"></select>
      </div>
      <div class="flex flex-wrap gap-2 mb-2">
        <button id="btn-load-month" class="px-4 py-2 bg-blue-600 text-white rounded text-base">載入本月資料</button>
        <button id="btn-copy" class="px-4 py-2 bg-gray-200 rounded text-base">複製</button>
        <span id="loading-status" class="ml-2 text-gray-500 text-sm"></span>
      </div>
      <div class="mb-2">
        <h3 class="font-semibold">WhatsApp 友好格式：</h3>
        <textarea id="whatsapp-output" class="w-full mt-1 p-2 border rounded h-60 text-sm md:text-base" readonly></textarea>
      </div>
      <div id="view-table-container" class="mt-2 bg-white rounded shadow p-2 overflow-auto max-h-[40vh]">
        <table id="view-table" class="min-w-full text-sm md:text-base"></table>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-2">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-4 overflow-auto">
      <div class="flex justify-between items-start mb-2">
        <div>
          <h3 id="modal-title" class="text-lg font-semibold"></h3>
          <p id="modal-sub" class="text-sm text-gray-500"></p>
        </div>
        <button id="modal-close" class="text-gray-500 text-lg">✕</button>
      </div>
      <div class="mt-2">
        <label class="block text-sm font-medium">選擇日期</label>
        <select id="modal-date" class="mt-1 p-2 border rounded w-full text-base"></select>
      </div>
      <div class="mt-2">
        <label class="block text-sm font-medium">選擇教練（可多選）</label>
        <div id="modal-coaches" class="mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
      </div>
      <div class="mt-3 flex gap-2 justify-end">
        <button id="modal-submit" class="px-4 py-2 bg-green-600 text-white rounded text-base">確定送出</button>
        <button id="modal-cancel" class="px-4 py-2 bg-gray-200 rounded text-base">取消</button>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-4 right-4 hidden bg-green-600 text-white px-4 py-2 rounded shadow-lg">
    ✅ 已送出並更新資料
  </div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
  (function(){
    const SHEET_ID = '1Rzb2I-0wPNjWOqTKMwx1Z6gVMMVtu2D3ekWwAHvJZUg';
    const CLASS_INFO_SHEET = 'Class info';
    const SHEET1_GID = '103185592';
    const FORM_ID = '1FAIpQLSdTYHzLfQKVxhWpAzfuf8I9amdT_vDoNs843tBD35OnlGc53A';
    const FORM_ENTRIES = {
      date: 'entry.176770776',
      course: 'entry.1115358630',
      time: 'entry.1251335978',
      coach: 'entry.1253762114'
    };

    const cardsEl = document.getElementById('cards');
    const modalEl = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalDate = document.getElementById('modal-date');
    const modalCoaches = document.getElementById('modal-coaches');
    const modalSubmit = document.getElementById('modal-submit');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');

    const tabAttend = document.getElementById('tab-attend');
    const tabView = document.getElementById('tab-view');
    const panelAttend = document.getElementById('panel-attend');
    const panelView = document.getElementById('panel-view');

    const viewCourse = document.getElementById('view-course');
    const viewYear = document.getElementById('view-year');
    const viewMonth = document.getElementById('view-month');
    const btnLoadMonth = document.getElementById('btn-load-month');
    const btnCopy = document.getElementById('btn-copy');
    const viewTable = document.getElementById('view-table');
    const loadingStatus = document.getElementById('loading-status');
    const whatsappOutput = document.getElementById('whatsapp-output');
    const toast = document.getElementById('toast');

    let classInfoRows = [];
    let sheet1Rows = [];

    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        if(btn===tabAttend){
          panelAttend.classList.remove('hidden');
          panelView.classList.add('hidden');
          tabAttend.classList.add('bg-blue-600','text-white');
          tabAttend.classList.remove('bg-white','text-gray-800');
          tabView.classList.add('bg-white','text-gray-800');
          tabView.classList.remove('bg-blue-600','text-white');
        } else {
          panelView.classList.remove('hidden');
          panelAttend.classList.add('hidden');
          tabView.classList.add('bg-blue-600','text-white');
          tabView.classList.remove('bg-white','text-gray-800');
          tabAttend.classList.add('bg-white','text-gray-800');
          tabAttend.classList.remove('bg-blue-600','text-white');
        }
      });
    });

    function gvizFetch(sheetOrGid){
      const url = /^[0-9]+$/.test(sheetOrGid)
        ? `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${sheetOrGid}&t=${Date.now()}`
        : `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetOrGid)}&t=${Date.now()}`;
      return fetch(url)
        .then(r=>r.text())
        .then(text=>{
          const jsonText = text.replace(/^[^\(]*\(/, '').replace(/\);?$/, '');
          const obj = JSON.parse(jsonText);
          const rows = obj.table.rows.map(r=>r.c.map(c=>c ? (c.f||c.v||'') : ''));
          return rows;
        });
    }

    function parseDateFlexible(s){
      if(!s) return null;
      if(/^\d{4}\/\d{1,2}\/\d{1,2}$/.test(s)) return new Date(s);
      if(/^\d{1,2}\/\d{1,2}$/.test(s)){
        const parts=s.split('/');
        return new Date(new Date().getFullYear(), +parts[0]-1, +parts[1]);
      }
      return null;
    }

    function ymd(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

    loadAll();

    function loadAll(){
      Promise.all([gvizFetch(CLASS_INFO_SHEET), gvizFetch(SHEET1_GID)]).then(([classInfo, sheet1])=>{
        classInfoRows = classInfo.slice(1).map(r=>({course:r[0]||'',time:r[1]||'',date:r[2]||'',coach:r[3]||''}));
        sheet1Rows = sheet1.slice(1).map(r=>({course:r[1]||'',time:r[2]||'',date:r[3]||'',coach:r[4]||''}));
        renderCards(); populateViewSelectors();
      });
    }

    function renderCards(){
      const seen = new Set();
      cardsEl.innerHTML='';
      classInfoRows.forEach(r=>{
        const key=r.course+'@@'+r.time;
        if(!seen.has(key)){
          seen.add(key);
          const div=document.createElement('div');
          div.className='bg-white rounded shadow p-4 flex flex-col justify-between';
          div.innerHTML=`<div><div class="text-lg font-semibold">${r.course}</div><div class="text-sm text-gray-500 mt-1">${r.time}</div></div><div class="mt-4 text-right"><button class="px-3 py-2 bg-blue-600 text-white rounded btn-open">點進去</button></div>`;
          div.querySelector('.btn-open').addEventListener('click',()=>openModal(r.course,r.time));
          cardsEl.appendChild(div);
        }
      });
    }

    function openModal(course,time){
      modalTitle.textContent=`${course} - ${time}`;
      const dates=[...new Set(classInfoRows.filter(r=>r.course===course&&r.time===time).map(r=>r.date.split(/[,，]/).map(x=>x.trim())).flat())].filter(Boolean);
      const coaches=[...new Set(classInfoRows.filter(r=>r.course===course&&r.time===time).map(r=>r.coach.split(/[,，]/).map(x=>x.trim())).flat())].filter(Boolean);

      const today = new Date();
      let closest = dates[0]; let minDiff = Infinity;
      dates.forEach(d=>{
        const dt = parseDateFlexible(d);
        if(dt && dt >= today){
          const diff = dt - today;
          if(diff < minDiff){ minDiff = diff; closest = d; }
        }
      });

      modalDate.innerHTML = dates.map(d=>`<option ${d===closest?'selected':''}>${d}</option>`).join('');
      modalCoaches.innerHTML=coaches.map(c=>`<label class="flex items-center gap-2 p-2 border rounded"><input type="checkbox" class="coach-check" value="${c}"><span>${c}</span></label>`).join('');
      modalEl.classList.remove('hidden'); modalEl.style.display='flex';
      modalSubmit.onclick=()=>submitForm(course,time);
    }

    function closeModal(){modalEl.classList.add('hidden');modalEl.style.display='none';}
    modalClose.onclick=modalCancel.onclick=closeModal;

    function submitForm(course,time){
      const date=modalDate.value;
      const coaches=Array.from(document.querySelectorAll('.coach-check:checked')).map(c=>c.value);
      if(!date||!coaches.length){alert('請選日期與教練');return;}
      const form=document.createElement('form');
      form.action=`https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
      form.method='POST';form.target='hidden_iframe';
      const add=(n,v)=>{const i=document.createElement('input');i.type='hidden';i.name=n;i.value=v;form.appendChild(i);};
      add(FORM_ENTRIES.date,date); add(FORM_ENTRIES.course,course); add(FORM_ENTRIES.time,time);
      coaches.forEach(c=>add(FORM_ENTRIES.coach,c));
      document.body.appendChild(form); form.submit();
      closeModal(); toastShow();
      setTimeout(()=>refreshSheet1(),2000);
    }

    function toastShow(){toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'),2500);}

    function refreshSheet1(){
      loadingStatus.textContent='更新中...';
      gvizFetch(SHEET1_GID).then(rows=>{
        sheet1Rows = rows.slice(1).map(r=>({course:r[1]||'',time:r[2]||'',date:r[3]||'',coach:r[4]||''}));
        loadingStatus.textContent='✅ 已更新';
        setTimeout(()=>loadingStatus.textContent='',2000);
      });
    }

    function populateViewSelectors(){
      const courses=[...new Set(sheet1Rows.map(r=>r.course))].filter(Boolean).sort();
      viewCourse.innerHTML='<option value="">--選課程--</option>'+courses.map(c=>`<option>${c}</option>`).join('');
      const now=new Date();
      viewYear.innerHTML=`<option>${now.getFullYear()}</option>`;
      viewMonth.innerHTML=Array.from({length:12},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
      viewMonth.value=now.getMonth()+1;
    }

    btnLoadMonth.onclick=()=>{
      const c=viewCourse.value, y=+viewYear.value, m=+viewMonth.value;
      if(!c) return alert('請選課程');

      const filtered = sheet1Rows.map(r=>({...r,d:parseDateFlexible(r.date)}))
        .filter(r=>r.course===c && r.d && r.d.getFullYear()===y && r.d.getMonth()+1===m);
      if(!filtered.length){ viewTable.innerHTML='<tr><td class="p-2">查無資料</td></tr>'; whatsappOutput.value=''; return; }

      // WhatsApp 友好格式
      const monthName = `${y}年${m}月`;
      const time = filtered[0].time;
      let whatsappText = `*${c}*\n\n${monthName}\n${time}`;
      const dateMap = {};
      filtered.forEach(r=>{
        if(!dateMap[r.date]) dateMap[r.date]=[];
        dateMap[r.date].push(r.coach);
      });
      Object.keys(dateMap).sort().forEach(d=>{
        whatsappText += `\n${d}\n${dateMap[d].join(', ')}`;
      });
      whatsappOutput.value = whatsappText;

      // 原始表格
      viewTable.innerHTML='<thead class="bg-gray-100"><tr><th class="p-2 text-left">日期</th><th class="p-2 text-left">時間</th><th class="p-2 text-left">教練</th></tr></thead><tbody>'+
        filtered.sort((a,b)=>a.d-b.d)
          .map(r=>`<tr class="border-t"><td class="p-2">${r.date}</td><td class="p-2">${r.time}</td><td class="p-2">${r.coach}</td></tr>`).join('')+
        '</tbody>';
    };

    btnCopy.onclick=()=>{ whatsappOutput.select(); document.execCommand('copy'); alert('已複製 WhatsApp 格式內容'); };

  })();
  </script>
</body>
</html>
